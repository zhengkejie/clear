var _gaq=[];_gaq.push(["_setAccount","UA-92398359-4"]),_gaq.push(["_set","page","/extension/"+chrome.runtime.getManifest().version+"/background"]),_gaq.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://www.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();class e{async init(){this.clearlyConfig=await this.getClearlyConfig(),this.updateClearlyConfig()}async getConfig(e){return{system:{lang:chrome.i18n.getUILanguage()},clearly:this.clearlyConfig,user:await this.getUserConfig(e),manifest:this.manifest,autoOpen:await this.getAutoOpen(e)}}async getUserConfig({tabId:e}){const t={theme:"default",zoom:1,outline:!0,themeDay:"default",openTip:!0,themeNight:"gray",themeAuto:!1,letterSpacing:"0",lineHeight:"1.6",font:"System",systemFont:"Georgia",syntax:!0,width:2,background:!0,linkOpenNew:!0,translateLang:navigator.language.split("-").shift(),speakRate:"1",roundCorner:!1,speakPitch:1,readUpdates:!1};return new Promise((e,a)=>{chrome.storage.local.get(["config"],a=>{Object.assign(t,a.config||{}),e(t)})})}updateClearlyConfig(){return fetch("https://api.clearlyreader.com/api/getChromeConfig",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version:this.clearlyConfig?this.clearlyConfig.version:null})}).then(e=>e.json()).then(e=>!(!e||0!==e.code)&&(this.clearlyConfig=e.data,chrome.storage.local.set({"system-config":this.clearlyConfig}),this.clearlyConfig))}getClearlyConfig(){return new Promise((e,t)=>{chrome.storage.local.get(["clearly-config"],t=>{if(!t["clearly-config"])return this.updateClearlyConfig().then(t=>e(t));e(t["clearly-config"])})})}getAutoOpen({url:e}){if(console.log("getAutoOpen",e),!e)return!1;const t=new URL(e),a=t.hostname,s="/"+t.pathname.split("/")[1],r=[{mode:"",value:"off"},{mode:"site",value:"(this site)"},{mode:"dir",value:"(this site)"+s}];return"/"===s&&r.pop(),new Promise((e,t)=>{chrome.storage.local.get([`auto-rule.${a}`],t=>{const o=t[`auto-rule.${a}`]||"";let n;n=o.includes(s+"|")?{...r[2],availableOptions:r}:"*"===o?{...r[1],availableOptions:r}:{...r[0],availableOptions:r},e(n)})})}setAutoOpen({url:e,mode:t="site"}){if(!e)return!1;const a=new URL(e),s=a.hostname,r="/"+a.pathname.split("/")[1],o=`auto-rule.${s}`,n=[{mode:"",value:"off"},{mode:"site",value:s},{mode:"dir",value:s+r}];return new Promise((e,a)=>{chrome.storage.local.get([o],a=>{let s,i=a[o]||"";"site"===t?(i="*",s={...n[1],availableOptions:n}):"dir"===t?(i=i+r+"|",s={...n[2],availableOptions:n}):(i=!1,s={...n[0],availableOptions:n}),i?chrome.storage.local.set({[o]:i}):chrome.storage.local.remove(o),e(s)})})}saveUserConfig({config:e}){return!!e&&(delete e.clearly,delete e.lang,delete e.tabId,delete e.voices,delete e.voice,delete e.speakVoice,new Promise((t,a)=>{chrome.storage.local.set({config:e},e=>{t(!0)})}))}submitArticle(e){return this.callApi("submitArticle",e)}submitFeedback(e){return this.callApi("submitFeedback",e)}getWiki(e){return this.callApi("card/wiki",e)}getSearch(e){return this.callApi("card/search",e)}getTranslate(e){return this.callApi("card/translate",e)}getSystemFonts(){return new Promise((e,t)=>{chrome.fontSettings.getFontList(e)})}updateIcon({status:e,tabId:t}){e=e||"default",chrome.browserAction.setIcon({path:{16:`/assets/icons/${e}/ic_16.png`,32:`/assets/icons/${e}/ic_32.png`,48:`/assets/icons/${e}/ic_48.png`,128:`/assets/icons/${e}/ic_128.png`},tabId:t})}ga({data:e}){console.debug("ga",e),void 0!==_gaq&&_gaq.push(e)}detectLanguage({tabId:e}){return new Promise((t,a)=>{chrome.tabs.detectLanguage(e,e=>{chrome.runtime.lastError&&t(null),t(e)})})}toggle(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){e[0]&&e[0].url.startsWith("http")&&chrome.tabs.executeScript(null,{code:"try{ClearlyContent.toggle()}catch(err){console.debug('Open clearly failed', err)}"})})}callApi(e,t){return fetch(`https://clearlyreader.com/api/${e}`,{method:"POST",body:JSON.stringify(t),headers:{"content-type":"application/json"}}).then(e=>e.json()).then(e=>{if(0!==e.code)throw new Error(`api error ${e.code}`);return e.data})}sendMessage(e){this.speakTabId&&chrome.tabs.get(this.speakTabId,t=>{t?(chrome.tabs.sendMessage(this.speakTabId,{...e,frame:!0}),chrome.runtime.lastError&&debug("lastError",chrome.runtime.lastError.message)):console.warn(`tab ${this.speakTabId}`)})}handleMessage(e,t,a){console.debug("handleMessage",e);const s=t.tab&&t.tab.id;if("function"==typeof this[e.type]){const t=this[e.type]({...e,tabId:s});if(t instanceof Promise)return t.then(e=>a({result:e})).catch(e=>a({error:e.message})),!0;a(t)}}registerChromeHandlers(){this.manifest=chrome.runtime.getManifest(),chrome.tts&&chrome.tts.isSpeaking(e=>{e&&e.length&&chrome.tts.stop()}),chrome.contextMenus.removeAll(),chrome.contextMenus.create({title:"Open Clearly",contexts:["page","selection","image","video"],onclick:this.toggle,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({title:"Open with Clearly",contexts:["link"],onclick:(e,t)=>{chrome.tabs.create({url:e.linkUrl+"#clearly"})}}),chrome.commands.onCommand.addListener(e=>{switch(e){case"toggle":this.toggle()}}),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.browserAction.onClicked.addListener(()=>this.toggle()),chrome.tabs.query({lastFocusedWindow:!0,active:!0},e=>{e[0]&&(this.currentTabId=e[0].id)}),chrome.tabs.onUpdated.addListener((e,t)=>{console.debug("TAB UPDATE",{tabId:e,changeInfo:t}),"loading"===t.status&&e===this.speakTabId&&this.speakStop({force:!0})}),chrome.tabs.onRemoved.addListener(e=>{console.debug("TAB REMOVE",{tabId:e}),e===this.speakTabId&&this.speakStop({force:!0})}),chrome.tabs.onActivated.addListener(e=>{console.debug("TAB ACTIVATED",e),this.currentTabId=e.tabId}),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason?chrome.tabs.create({url:"https://clearlyreader.com/r/install?v="+this.manifest.version,selected:!0}):e.reason}),chrome.runtime.setUninstallURL("https://clearlyreader.com/r/uninstall?v="+this.manifest.version),this.init()}static googleToken(){return Math.random().toString().substr(2,7)+"."+Math.random().toString().substr(2,7)}static hashCode(e){let t,a,s=0;if(0===e.length)return s;for(t=0;t<e.length;t++)s=(s<<5)-s+(a=e.charCodeAt(t)),s|=0;return s}static bootstrap(){const t=new e(window);return t.registerChromeHandlers(),t}}window.background=e.bootstrap();