class ClearlyApp{constructor(){this.callbackStart(),this.state={},this.config={}}load(e,t){if(!this.boot&&!t)return!1;this.setState({isReady:!0});const o=this.article=e.article;return this.url=e.url,this.renderArticle(o),!!this.article&&(this.sendGA(["_set","title",this.article.title]),this.sendGA(["_trackPageview","open?url="+this.article.url]),this.setState({load:!0,lang:this.getMainLang()}),o.outline&&o.outline.length&&""!==o.outline[0].id&&o.outline.unshift({title:o.title,id:"ros-0",type:"h1"}),o.outline&&($("#outlines").html(DOMPurify.sanitize(o.outline.map(e=>'<li id="outline-'+e.id+'" class="outline-section outline-'+e.type+'"><a href="javascript:;" data-id="#'+e.id+'">'+e.title+"</a></li>").join("\n"),{SAFE_FOR_JQUERY:!0})),o.outline.length||$("#switch-outline").addClass("s-disable")),o.links&&o.links.length>0&&($("#links").html(DOMPurify.sanitize(o.links.filter(e=>"text"===e.type).map(e=>`<li class="links-item"><a href="${e.url}">${e.title}</a></li>`).join("\n"),{SAFE_FOR_JQUERY:!0})),$("#links-container").show()),$("#btn-cantact").attr("href","https://clearlyreader.com/r/report?url="+encodeURIComponent(this.url)),this.afterInit(),!0)}renderArticle(e){if(document.querySelector("html").setAttribute("dir",e&&e.rtl?"rtl":""),e)$("#container").html(DOMPurify.sanitize(`<div id="subject">${e.title}</div>\n      <div id="byline">\n      ${e.authorName?"<span>"+e.authorName+"</span>":""}\n      <span>${this.message("app.article.estimated",e.readTime)}</span>\n      <span>${this.message("app.article.wordscount",e.wordsCount)}</span>\n      <span>${this.message("app.article.lang",String(e.lang||"en").toUpperCase())}</span>\n      </div>\n      <div id="cover" style="background-image:${e.coverUrl?"url('"+e.coverUrl+"')":"none;display:none"}"></div>\n      <div id="content">${e.content}</div>`,{ADD_TAGS:["iframe"],SAFE_FOR_JQUERY:!0,ALLOWED_ATTR:["id","style","src","alt","href","class","srcset","title"]})),this.speakContent=this.article.textContent;else{const e=this.getQuotes(),t=e[Math.floor(Math.random()*e.length)],[o,n]=t.split(" – ");$("#container").html(DOMPurify.sanitize(`<div id="title"></div><div id="cover"></div><div id="byline"></div><div id="#content"><div class="quote"><div class="quote-text">${o}</div><div class="quote-author">${n}</div></div></div>`,{SAFE_FOR_JQUERY:!0}))}}afterInit(){window.hljs&&this.config.syntax&&(hljs.configure({ignoreUnescapedHTML:!0}),document.querySelectorAll("pre,code").forEach(e=>{e.classList.contains("hljs")||e.childNodes[0]&&"CODE"===e.childNodes[0].tagName||hljs.highlightElement(e)}));const e=document.querySelector("#content");this.speakMarker=new Mark(e),this.bindEvents()}getQuotes(){return["“A reader lives a thousand lives before he dies . . . The man who never reads lives only one.” – George R.R. Martin,","“Until I feared I would lose it, I never loved to read. One does not love breathing.” – Harper Lee","“Never trust anyone who has not brought a book with them.” – Lemony Snicket","“You can never get a cup of tea large enough or a book long enough to suit me.” – C.S. Lewis","“Reading is essential for those who seek to rise above the ordinary.” – Jim Rohn","“I find television very educating. Every time somebody turns on the set, I go into the other room and read a book.” – Groucho Marx","“‘Classic’, a book which people praise and don’t read.” – Mark Twain","“You don’t have to burn books to destroy a culture. Just get people to stop reading them.” – Ray Bradbury","“So please, oh please, we beg, we pray, go throw your TV set away, and in its place you can install a lovely bookshelf on the wall.” – Roald Dahl","“Think before you speak. Read before you think.” – Fran Lebowitz","“Let’s be reasonable and add an eighth day to the week that is devoted exclusively to reading.” – Lena Dunham","“The reading of all good books is like conversation with the finest (people) of the past centuries.” – Descartes","“In the case of good books, the point is not to see how many of them you can get through, but rather how many can get through to you.” – Mortimer J. Adler","“Reading one book is like eating one potato chip.” – Diane Duane","“The more that you read, the more things you will know. The more that you learn, the more places you’ll go.” – Dr. Seuss","Like Dr. Suess? Want to see our entire collection of quotes from Dr. Suess?","“Books are a uniquely portable magic.” – Stephen King","“I read a book one day and my whole life was changed.” – Orhan Pamuk","“People say that life is the thing, but I prefer reading.” – Logan Pearsall Smith","“Today a reader, tomorrow a leader.” – Margaret Fuller","“People can lose their lives in libraries. They ought to be warned.” – Saul Bellow"]}closePopmenu(e){this.lastSelection=null,this.setState({popupOverlayData:null}),$("#popmenu").hide(),$("#poptranslate").hide(),$("#popshare").hide(),$("body").off("click",this.closePopmenu.bind(this))}clickPopmenu(e){const t=window.getSelection().toString().trim();if(t){switch(this.lastSelectedText=t,e){case"translate":this.startPopTranslate(t);break;case"copy":document.execCommand("copy"),this.closePopmenu();break;case"speak":window.speechSynthesis.speaking&&window.speechSynthesis.cancel();const o=new SpeechSynthesisUtterance(t);o.voice=this.state.voices.find(e=>e.localService&&e.lang.includes(this.article.lang||"en")),o.voice||(o.voice=this.state.voices[0]),o.volume=1,window.speechSynthesis.speak(o),this.closePopmenu();break;case"search":this.callBackground("getSearch",{keyword:t}).then(e=>this.showPopmenuOverlay({type:"search",data:e}));break;case"wiki":this.callBackground("getWiki",{text:t}).then(e=>this.showPopmenuOverlay({type:"wiki",data:e}));break;case"share":html2canvas(document.querySelector("#root")).then(e=>{document.body.appendChild(e)});break;case"highlight":highlightSelection(),this.closePopmenu(),window.getSelection().empty()}this.sendGA(["_trackEvent","Popmenu",e])}}showPopmenuOverlay(e){this.setState({popupOverlayData:e})}keepSelection(){if(!this.lastSelection)return;let e=window.getSelection(),t=e.toString(),o=this.lastSelection.ranges;t&&e.removeAllRanges();for(let t=0,n=o.length;t<n;++t)e.addRange(o[t])}async startPopTranslate(t){try{const o=await this.translate(t,this.config.translateLang);this.showPopmenuTranslate(o)}catch(t){e("error",t)}}updateSystemConfig(){this.callBackground("updateClearlyConfig").then(e=>{e&&e.version?(this.setState({clearlyConfigVersion:e.version}),this.alert("ok","Config updated, refresh page to enable new config")):this.alert("warn","Config outdated")})}showPopmenu(){const e=window.getSelection().toString().trim();if(!e)return;const t=this.lastSelection&&this.lastSelection.position;if(!t)return;const o=(window.pageYOffset+t.y-$("#popmenu").height()-10)*parseFloat(this.config.zoom||1),n=(window.pageXOffset+t.x+(t.width-$("#popmenu").width())/2)*parseFloat(this.config.zoom||1);$("#poptranslate").hide(),$("#popmenu").show(),$("#popmenu").css({left:n,top:o}),o<250?$("#popmenu").addClass("popmenu-down"):$("#popmenu").removeClass("popmenu-down"),e.length>30?$("#popmenu").addClass("popmenu-long"):$("#popmenu").removeClass("popmenu-long"),this.popmenuCloseTimer&&(clearTimeout(this.popmenuCloseTimer),this.popmenuCloseTimer=null),this.popmenuCloseTimer=setTimeout(()=>{$("body").on("click",this.closePopmenu.bind(this)),this.popmenuCloseTimer=null},200)}getAncestorTag(e,t,o){o=o||5;let n=0;for(;e.parentNode;){if(o>0&&n>o)return!1;if(t.startsWith(".")&&e.parentNode.classList.contains(t.substr(1,t.length-1)))return e.parentNode;if(e.parentNode.tagName.toUpperCase()===t.toUpperCase())return e.parentNode;e=e.parentNode,n++}return!1}showClearlyBtn(e){const t=e.target,o=t.getAttribute("href");if(t&&"A"===t.nodeName&&o&&o.startsWith("http")){const n=t.getBoundingClientRect();let s=window.pageYOffset+n.y-n.height,a=e.pageX-12.5;n.height>27&&(s+=30),e.pageY-s>50&&(s+=30),$("#clearly-btn").show(),$("#clearly-btn").css({left:a,top:s}),$("#clearly-btn").data("url",o)}else"clearly-btn"!==e.target.getAttribute("id")&&$("#clearly-btn").hide()}openClearlyBtn(){const e=$("#clearly-btn").data("url");e&&window.open(e+"#clearly","_blank"),this.sendGA(["_trackEvent","CHROME_APP","CLICK_CLEARLY_BTN"])}handleClick(e){e.preventDefault();const t=e.target.getAttribute("href");t&&t.startsWith("http")&&(this.config.linkOpenNew?window.open(t,"_blank"):location.href=t)}showPopmenuTranslate(e){let t=this.lastSelection.position;if($("#popmenu").hide(),!e){const e=800,t=600,o=window.outerHeight/2+window.screenY-t/2,n=window.outerWidth/2+window.screenX-e/2;return void window.open(`https://translate.google.com/?sl=auto&text=${encodeURIComponent(this.lastSelectedText)}&op=translate`,"translate",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, copyhistory=no, width=${e}, height=${t}, left=${n}, top=${o}`)}let o=e.sentences.map(e=>e.trans||"").join("");if($("#poptranslate").show(),$("#poptranslate-explain").html(o),$("#poptranslate-voice").hide(),e.dict){$("#poptranslate").addClass("poptranslate-wordmode");let t=e.sentences.find(e=>e.translit);t.src_translit&&($("#poptranslate-voice span").html(`[${t.src_translit}]`),$("#poptranslate-voice").show()),$("#poptranslate-translit").html(t.translit||""),$("#poptranslate-word").html(this.lastSelection.text);let o=e.dict.map(e=>`${e.pos[0]}. ${e.terms.join("; ")}`).join("<br />");$("#poptranslate-dict").html(o)}else $("#poptranslate").removeClass("poptranslate-wordmode");$("#poptranslate").css({left:window.pageXOffset+t.x+(t.width-$("#poptranslate").width())/2,top:window.pageYOffset+t.y-$("#poptranslate").height()-30})}getAndSaveSelection(){let e=window.getSelection(),t=e.toString();if(!t)return!1;let o=[];if(e.rangeCount)for(let t=0,n=e.rangeCount;t<n;++t)o.push(e.getRangeAt(t));return this.lastSelection={ranges:o,text:t,position:e.getRangeAt(0).getBoundingClientRect()},!0}show(e,t){this.load(e,t)&&this.sendGA(["_trackEvent","App","Show"])}action(t,o){switch(e("action",t,o),t){case"close":this.callParent({type:"fullscreen",fullscreen:!1}),this.callParent({type:"close"}),this.shutdown();break;case"share":this.setState({isSharing:o}),this.callBackground("submitFeedback",{article:this.article,feedback:o.toUpperCase()});break;case"zoomIn":this.setConfig({zoom:((parseFloat(this.config.zoom,10)||1)-.1).toFixed(2)});break;case"zoomOut":this.setConfig({zoom:((parseFloat(this.config.zoom,10)||1)+.1).toFixed(2)});break;case"increseWidth":let n=(parseInt(this.config.width,10)||0)+1;n<5&&n>=0&&this.setConfig({width:n});break;case"decreseWidth":let s=(parseInt(this.config.width,10)||0)-1;s<5&&s>=0&&this.setConfig({width:s});break;case"exportDoc":const a=["<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export From Word</title></head><body>","<h1>"+this.article.title+"</h1>",document.getElementById("content").getElementsByTagName("article")[0].innerHTML,'<p style="text-align:center">[ Generated by <a href="https://clearlyreader.com">Clearly Reader<a/> ]</p>',"</body></html>"].join(""),i=document.createElement("a");i.setAttribute("download",this.article.title+".doc"),i.setAttribute("href","data:application/vnd.ms-word;charset=utf-8,"+encodeURIComponent(a)),i.click();break;case"exportMarkdown":const l=document.createElement("a");l.setAttribute("download",this.article.title+".md"),l.setAttribute("href","data:plain/txt;charset=utf-8,p"+encodeURIComponent(this.covertMarkdown())),l.click();break;case"copyMarkdown":const c=document.createElement("textarea");c.value=this.covertMarkdown(),document.body.appendChild(c),c.select(),document.execCommand("Copy"),c.remove(),this.alert("ok","Markdown copied");break;case"copyHTML":const r=document.createElement("textarea");r.value=document.getElementById("content").innerHTML+'<p style="text-align:center">[ Generated by <a href="https://clearlyreader.com">Clearly Reader<a/> ]</p>',document.body.appendChild(r),r.select(),document.execCommand("Copy"),r.remove(),this.alert("ok","HTML copied");break;case"copyClipUrl":this.copy(this.state.clipUrl),this.alert("ok","URL copied");break;case"copyTranslate":this.copy($("#poptranslate-explain").text()),this.alert("ok","Translate copied");break;case"print":window.print();break;case"exportPDF":break;case"copyArticle":const h=document,d=h.getElementById("container");let p,m;h.body.createTextRange?((p=h.body.createTextRange()).moveToElement(d),p.select()):window.getSelection&&(m=window.getSelection(),(p=h.createRange()).selectNodeContents(d),m.removeAllRanges(),m.addRange(p)),document.execCommand("copy"),window.getSelection().removeAllRanges(),this.alert("ok","Article copied");break;case"speakText":break;case"toggleFullscreenMode":this.setState({fullscreen:!this.state.fullscreen}),this.callParent({type:"fullscreen",fullscreen:this.state.fullscreen});break;case"changeLanguage":this.setConfig({translateLang:o}),this.startPopTranslate(this.lastSelectedText);break;case"report":window.open("https://clearlyreader.com/r/report?url="+encodeURIComponent(this.url))}this.sendGA(["_trackEvent","Action",t])}translate(e,t){const o=Math.random().toString().substr(2,7)+"."+Math.random().toString().substr(2,7);return fetch(`https://translate.googleapis.com/translate_a/single?dt=t&dt=bd&dt=qc&dt=rm&client=gtx&sl=auto&tl=${t}&q=${encodeURIComponent(e)}&hl=en-US&dj=1&tk=${o}`,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>e.json())}copy(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),t.remove()}covertMarkdown(){const e=new TurndownService;return e.remove("footer"),[e.turndown(document.getElementById("container")),"> Generated by [Clearly Reader](https://clearlyreader.com)"].join("\n")}alert(e,t){$("#alert-message").text(t),$("#alert").attr("class",""),$("#alert").addClass("alert-"+e),$("#alert").addClass("show"),setTimeout(e=>$("#alert").removeClass("show"),2e3)}handleState(t,o,n,s){if(o!==n)switch(e("handleState",t,o,n),this.handleStateBind(t,o,n),t){case"params":o&&o.showDialog&&this.setState({showDialog:o.showDialog});break;case"speak":if(!this.article)return;if("RESTART"===o)return void this.setState({speakStartPos:0,speakPos:0,speak:"START",speakMark:!0},s);switch(this.sendGA(["_trackEvent","Speak",o]),o){case"PAUSE":$("#menu-speak").addClass("menu-actived"),$("#menu-speak .active").text("volume_off"),"click"===s&&window.speechSynthesis.cancel(),this.setState({speakStartPos:this.state.speakPos,speakPos:0});break;case"START":const e=["Daniel","Daniel(Enhanced)","Rishi","Karen","Karen(Enhanced)","Meijia",""];let t;if(t=this.state.speakStartPos?{text:this.speakContent.substr(this.state.speakStartPos,this.speakContent.length-this.state.speakStartPos),rate:this.config.speakRate,voiceName:this.state.speakVoice,pitch:this.config.speakPitch||1}:{text:this.speakContent,rate:this.config.speakRate,voiceName:this.state.speakVoice,pitch:this.config.speakPitch||1},"click"===s){window.speechSynthesis.speaking&&window.speechSynthesis.cancel();const o=new SpeechSynthesisUtterance(t.text);o.rate=Number(t.rate||"1"),o.voice=this.state.voices.find(e=>e.name===t.voiceName),o.voice||(o.voice=this.state.voices.find(e=>String(e.lang).toLowerCase()===String(this.article.lang).toLowerCase())),o.voice||(o.voice=this.state.voices.find(e=>String(e.lang.split("-").shift()).toLowerCase()===String(this.article.lang.split("-").shift()).toLowerCase())),o.voice||this.state.voices.find(e=>e.default),o.voice&&e.includes(o.voice.name)?(this.setState({speakMark:!0}),o.onboundary=(e=>{this.setState({speakWord:e})})):this.setState({speakMark:"false"}),o.pitch=t.pitch,o.volume=1,o.onpause=(()=>{this.setState({speak:"PAUSE"})}),o.onstop=o.onerror=(()=>{this.setState({speak:"STOP"})}),window.speechSynthesis.speak(o)}$("#menu-speak").addClass("menu-actived"),$("#menu-speak .active").text("volume_up");break;case"STOP":case null:$("#menu-speak").removeClass("menu-actived"),$("#menu-speak .active").text("volume_down"),"click"===s&&window.speechSynthesis.cancel(),this.setState({speakWord:null,speakStartPos:0,speakPos:0})}break;case"autoOpenMode":this.callBackground("setAutoOpen",{url:this.url,mode:o}).then(e=>this.setState({autoOpen:e})),this.sendGA(["_trackEvent","Set AutoOpen",o]);break;case"autoOpen":if(!o)return;this.setState({autoOpenValue:o.value}),$("#autoopen-select").html(o.availableOptions.map(e=>`<li click="autoOpenMode=${e.mode}">${e.value}</li>`).join("")),$("#autoopen").attr("class","autoopen-mode-"+o.mode);break;case"fullscreen":o?($("#menu-fullscreen").addClass("menu-actived"),$("#menu-fullscreen .material-icons").text("fullscreen_exit")):($("#menu-fullscreen").removeClass("menu-actived"),$("#menu-fullscreen .material-icons").text("fullscreen")),this.sendGA(["_trackEvent","Fullscreen",o]);break;case"isSharing":switch($(".share-overlay").hide(),o){case"yes":$("#share-yes").show();break;case"no":$("#share-no").show();break;case"finish":default:$("#share-default").show()}break;case"isReady":o?($("#loading").hide(),$("#tool").css("display","flex"),$("#container").show()):($("#loading").show(),$("#tool").css("display","none"),$("#container").hide());break;case"showDialog":$(".dialog").removeClass("dialog--open"),$(`#dialog-${o}`).addClass("dialog--open"),"about"===o&&setTimeout(e=>{this.setConfig({readUpdates:this.initConfig.manifest.version})},1e3),this.sendGA(["_trackEvent","Show Dialog",o]);break;case"fonts":$("#font-select-style").prepend(o.map(e=>{let t=e.name.toLowerCase().replace(/ /g,"");return`<span style="font-family:${t}" class="btn-font ${this.config.font===t?"font-selected":""}" bind-class="font-selected:config.font=${t}" click="config.font=${t}">${e.name}</span>`}).join(""));break;case"systemFonts":$("#font-custom").html(o.map(e=>`<option value="${e.fontId}" ${this.config.systemFont===e.fontId?"selected":""} stlye="font-family: ${e.fontId}">${e.displayName}</option>`));break;case"themes":$("#themes .themes-list").prepend(o.map(e=>`<span class="btn-theme ${e.theme===this.config.theme?"btn-selected":""}" click="config.theme=${e.theme}" style="background-color: ${e.bgColor};background-image:${e.bgImg?`url(${e.bgImg})`:"none"}; background-size:cover" bind-class="btn-selected:config.theme=${e.theme}"></span>`).join("")),$("#themes-day .themes-list").prepend(o.filter(e=>"day"===e.autoTheme).map(e=>`<span class="btn-theme ${e.theme===this.config.themeDay?"btn-selected":""}" click="config.themeDay=${e.theme}" style="background-color: ${e.bgColor};background-image:${e.bgImg?`url(${e.bgImg})`:"none"}; background-size:cover" bind-class="btn-selected:config.themeDay=${e.theme}"></span>`).join("")),$("#themes-night .themes-list").prepend(o.filter(e=>"night"===e.autoTheme).map(e=>`<span class="btn-theme ${e.theme===this.config.themeNight?"btn-selected":""}" click="config.themeNight=${e.theme}" style="background-color: ${e.bgColor};background-image:${e.bgImg?`url(${e.bgImg})`:"none"}; background-size:cover" bind-class="btn-selected:config.themeNight=${e.theme}"></span>`).join(""));break;case"popupOverlayData":if(o){const e=o.data.results.slice(0,5);$("#popmenu-overlay").html(""),e&&e.length?(e.forEach(e=>{$("#popmenu-overlay").prepend(`<a target="clearly-wiki" href="${e.link}"><div class="popmenu-overlay-item">\n            <div class="popmenu-item-title"><label>${e.title}</label></div>\n            <div class="popmenu-item-url">${e.displayUrl||e.link}</div>\n            <div class="popmenu-item-intro">${e.intro}</div>\n          </div></a>`)}),$("#popmenu-overlay").append('<div class="popmenu-overlay-footer">More results on <a href="'+o.data.moreUrl+'" target="_blank">'+("wiki"===o.type?"Wikipedia":"DuckDuckGo")+"</a></div>")):$("#popmenu-overlay").html('<div class="popmenu-overlay-empty">no result</div>'),$("#popmenu-overlay").css({visibility:"visible"})}else $("#popmenu-overlay").css({visibility:"hidden"}),$("#popmenu-overlay").html("");break;case"speakWord":if(this.speakMarker.unmark(),o&&"START"===this.state.speak){const t=this.state.speakStartPos+o.charIndex;this.setState({speakPos:t}),e("speak word",this.speakContent.substr(t,o.charLength)),this.speakMarker.markRanges([{start:t,length:o.charLength}],{className:"mark-word",element:"span",done:()=>{const e=document.querySelector("span.mark-word");if(!e)return;const{top:t,height:o}=e.getBoundingClientRect();t+o>window.innerHeight&&this.scrollTo(e)}})}break;case"speakVoice":$(`[click="speakVoice=${n}"]`).removeClass("selected"),$(`[click="speakVoice=${o}"]`).addClass("selected"),"START"===this.state.speak&&(this.setState({speak:"PAUSE"},s),this.setState({speak:"START"},s)),"click"===s&&this.state&&this.state.speakVoiceMap[this.getMainLang()]!==o&&("object"!=typeof this.state.speakVoiceMap&&(this.state.speakVoiceMap={}),this.setState({speakVoiceMap:{...this.state.speakVoiceMap,[this.getMainLang()]:o}}));break;case"voices":$("#menu-voices").append('<span class="item-voice" click="speakVoice=auto;showVoiceSelector=0">Auto</span>'),o&&o.length>0&&o.filter(e=>e.lang.split("-").shift()===this.getMainLang()&&e.localService).forEach(e=>{$("#menu-voices").append(`<span class="item-voice" click="speakVoice=${e.name};showVoiceSelector=0">${e.name}</span>`)});break;case"speakVoiceMap":this.setState({speakVoice:o&&o[this.getMainLang()]?o[this.getMainLang()]:"auto"},s)}}handleStateBind(t,o){e("handleStateBind",t,o);const n=o||"!";$(`[show*="${t}"]`).each((s,a)=>{$(a).attr("show").split(";").forEach(s=>{const[i,l]=String(s).trim().split("=");i===t&&(l.split(",").includes(n)||o&&"*"===l?(e("show state",t,s),$(a).show()):(e("hide state",t,s),$(a).hide()))})}),$(`[bind="${t}"]`).text(o),$(`[bind-css*="${t}"]`).each((e,n)=>{$(n).attr("bind-css").split(";").forEach(e=>{const[s,a]=e.split(":");String(a).trim()===t&&$(n).css(String(s).trim(),o)})}),$(`[bind-class*="${t}"]`).each((e,n)=>{$(n).attr("bind-class").split(";").forEach(e=>{const[s,a]=String(e).trim().split(":"),[i,l]=String(a).trim().split("=");i===t&&(l===o?$(n).addClass(s):$(n).hasClass(s)&&$(n).removeClass(s))})})}handleConfigBind(t,o){e("handleConfigBind",t,o),$(`[show*="config.${t}"]`).each((n,s)=>{$(s).attr("show").split(";").forEach(n=>{let[a,i]=String(n).trim().split("=");i||(a.startsWith("!")?(a=a.substring(1),i=!1):i=!0),a==="config."+t&&(o===i||"string"==typeof i&&i.split(",").includes(o)||o&&"*"===i?(e("show config",t,o,i,n),$(s).show()):(e("hide config",t,o,i,n),$(s).hide()))})}),$(`[bind="config.${t}"]`).each((e,t)=>{"INPUT"===t.nodeName||"SELECT"===t.nodeName?t.value=o:$(t).text(o)}),$(`[bind-css*="config.${t}"]`).each((e,n)=>{$(n).attr("bind-css").split(";").forEach(e=>{const[s,a]=e.split(":");String(a).trim()==="config."+t&&$(n).css(String(s).trim(),o)})}),$(`[bind-class*="config.${t}"]`).each((n,s)=>{e("handleConfigBind add",t,s);const a=$(s);a.attr("bind-class").split(";").forEach(n=>{const[s,i]=String(n).trim().split(":");let[l,c]=String(i).trim().split("=");c||(l.startsWith("!")?(l=l.substring(1),c=!1):c=!0),l==="config."+t&&(c===o?(e("handleConfigBind add",t,s),a.addClass(String(s).trim())):a.hasClass(s)&&(e("handleConfigBind remove",t,s),a.removeClass(s)))})})}handleConfig(t,o,n,s){if(o!==n&&("object"!=typeof o||JSON.stringify(o)!==JSON.stringify(n))){switch(e("handleConfig",t,o,n),this.handleConfigBind(t,o,n),t){case"theme":case"themeDay":case"themeNight":case"themeAuto":case"lineHeight":case"letterSpacing":case"roundCorner":this.selectTheme(n);break;case"zoom":document.getElementById("container").style.zoom=o,$("#value-zoom").text((100*o).toFixed(0)+"%");break;case"width":$("#value-width").text(10*(10+parseInt(o)-2)+"%"),$("#root").removeClass("width-"+n),$("#root").addClass("width-"+o);break;case"syntax":o?($("#switch-syntax").addClass("s-on"),$("#switch-syntax").removeClass("s-off")):($("#switch-syntax").removeClass("s-on"),$("#switch-syntax").addClass("s-off"));break;case"translateLang":$("#poptranslate-lang").val(o);break;case"speakRate":$(`[click="config.speakRate=${n}"]`).removeClass("selected"),$(`[click="config.speakRate=${o}"]`).addClass("selected"),"START"===this.state.speak&&(this.setState({speak:"PAUSE"},s),this.setState({speak:"START"},s));break;case"readUpdates":o!==this.initConfig.manifest.version?$("#btn-about").addClass("info"):$("#btn-about").removeClass("info");break;case"bgColor":case"mainColor":case"fontColor":case"codeBgColor":"custom"===this.config.theme&&this.selectTheme("custom");break;case"clearly":this.setState({version:o.version});break;case"font":"custom"===o&&this.getSystemFonts(),this.selectTheme();break;case"systemFont":this.selectTheme()}"init"!==s&&(this.sendGA(["_trackEvent","Update Config",t,String(o)]),this.saveUserConfig())}}getMainLang(){return(this.article&&this.article.lang||"en").split("-").shift()}selectTheme(e){const t=this.config&&this.config.themeAuto;let o="default";if(t){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;o=this.config[e?"themeNight":"themeDay"]}else o=this.config.theme;let n=ClearlyApp.DEFAULT_STATE.themes.find(e=>e.theme===o);e&&e!==o&&"custom"===o?(n=ClearlyApp.DEFAULT_STATE.themes.find(e=>"default"===e.theme),this.setConfig({...n,theme:"custom"})):"custom"===o&&(n=this.config);let s=document.querySelector("style#theme-style");s||((s=document.createElement("style")).id="theme-style",s.type="text/css",document.body.appendChild(s)),s.innerHTML=`\n    html {\n      background-image: ${n.bgImg?"url("+n.bgImg+")":"none"};\n      background-repeat: repeat;\n      background-color: ${n.bgColor};\n      font-family: "${"custom"===this.config.font?this.config.systemFont:this.config.font}";\n    }\n    #main {\n      background-color: ${n.mainColor};\n      color: ${n.fontColor};\n      background-image: ${n.mainImg?"url("+n.mainImg+")":"none"};\n      background-repeat: repeat;\n      ${this.config.roundCorner?"\n      border-radius: 20px;\n      margin-top: 10px;\n      margin-bottom: 10px;\n      padding-top: 54px;\n      ":""}\n    }\n    #main #content {\n      letter-spacing: ${this.config.letterSpacing?this.config.letterSpacing+"em":"normal"};\n      line-height: ${this.config.lineHeight||"1.6"}em;\n    }\n    #main a {\n      color: ${n.linkColor};\n      text-decoration: none;\n      border-bottom: 1px dashed ${n.fontColor};\n    }\n    #main a:hover {\n      text-decoration: none;\n      border-bottom: 2px solid ${n.fontColor};\n    }\n    #main h1, #main h2, #main h3, #main h4, #main h5 {\n      color: ${n.fontColor};\n    }\n    #main figcaption {\n      color: ${n.fontColor};\n      opacity: 0.5;\n    }\n    #outline div {\n      color: ${n.fontColor};\n    }\n    #outline a {\n      color: ${n.fontColor};\n    }\n    .menu i {\n      color: ${n.fontColor};\n    }\n    #btn-style::before {\n      background-color: ${n.fontColor};\n    }\n    #footer {\n      color: ${n.fontColor};\n      opacity: 0.5;\n    }\n    #footer .share-title {\n      background-color: ${n.mainColor};\n    }\n    ${n.css||""}\n    `}saveUserConfig(){if(this.config)return e("saveUserConfig",this.config),this.callBackground("saveUserConfig",{config:this.config})}sendGA(e){this.callBackground("ga",{data:e})}callParent(t){e("sendParent",t),parent.postMessage(t,"*")}callBackground(t,o){return e("callBackgroud",t,o),new Promise((e,n)=>{const s=String(Math.random());this.callbackWait(s,(t,o)=>{if(t)return n(t);e(o)}),parent.postMessage({...o||{},background:!0,type:t,callback:s},"*")})}callbackWait(t,o){e("callbackWait",t,o),this.callbacks[t]={fn:o,ts:Date.now()}}callbackReceive(t,o,n){e("callbackReceive",t,n,o);const{fn:s}=this.callbacks[t]||{};s&&s(n,o)}callbackStart(){e("callbackLoop"),this.callbacks||(this.callbacks={}),window.setInterval(e=>{const t=Date.now();Object.keys(this.callbacks).forEach(e=>{const{fn:o,ts:n}=this.callbacks[e];let s=null;t-n>1e4&&(delete this.callbacks[e],o(s=new Error(`call "${e}" timeout`),null))})},1e3)}getSystemFonts(){this.callBackground("getSystemFonts").then(e=>{this.setState({systemFonts:e})})}scrollTo(e,t=0){const o=document.body,n=Math.max(o.scrollHeight,o.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),s=window.innerHeight||document.documentElement.clientHeight||o.clientHeight,a="number"==typeof e?e:e.offsetTop,i=Math.round(n-a<s?n-s:a);window.scroll(0,i+t)}handleClickOutline(e){e.preventDefault(),e.stopPropagation();let t=$(e.target).data("id");if(t){if("#"===t||!t)return window.scroll(0,0);let e=document.querySelector(t);e&&this.scrollTo(e)}else{const t=document.querySelector("#content").querySelector(`a[href="${e.target.getAttribute("href")}"]`);t&&($(t).addClass("outline-clicked"),setTimeout(e=>$(t).removeClass("outline-clicked"),1e3),this.scrollTo(t,-200))}this.sendGA(["_trackEvent","Read","Click outline"])}bindEvents(){document.querySelectorAll("#content img").forEach(function(e){e.onerror=function(){this.style.display="none"}}),$("#outline").on("click","a",e=>this.handleClickOutline(e)),$("#btn-report").click(()=>this.action("report")),$("#btn-close").click(()=>this.action("close")),$("#btn-print,#btn-export").click(()=>this.action("print")),$("#btn-copy-article,#btn-copy").click(()=>this.action("copyArticle")),$("#btn-copy-markdown").click(()=>this.action("copyMarkdown")),$("#btn-copy-html").click(()=>this.action("copyHTML")),$("#btn-export-pdf").click(()=>this.action("exportPDF")),$("#btn-export-doc").click(()=>this.action("exportDoc")),$("#btn-export-md").click(()=>this.action("exportMarkdown")),$("#btn-zoomin").click(()=>this.action("zoomIn")),$("#btn-zoomout").click(()=>this.action("zoomOut")),$("#btn-content-zoomin").click(()=>this.action("decreseWidth")),$("#btn-content-zoomout").click(()=>this.action("increseWidth")),$("#menu-fullscreen").click(()=>this.action("toggleFullscreenMode")),$("#btn-copy-translate").click(e=>this.action("copyTranslate")),$("#root").on("click mousemove","[click],[mousemove]",e=>this.handleEvent(e)),$("#root").on("change","select[bind],input[bind]",e=>this.handleChange(e)),$("#btn-system-check").on("click",e=>this.updateSystemConfig()),$("#btn-clip-submit").on("click",e=>this.clipArticle()),$("#btn-clip-copy").on("click",e=>this.action("copyClipUrl")),$("#btn-thumb-up").click(()=>this.action("share","yes")),$("#btn-thumb-down").click(()=>this.action("share","no")),$("#content,#subject").on("click dragend",e=>{this.popmenuShowTimer&&(clearTimeout(this.popmenuShowTimer),this.popmenuShowTimer=null),this.popmenuShowTimer=setTimeout(t=>{this.getAndSaveSelection()&&(this.showPopmenu(e),e.stopPropagation()),this.popmenuShowTimer=null},200)}),$(".popmenu-item").click(e=>this.clickPopmenu($(e.target).data("type"))),$("#popmenu,#popshare,#poptranslate").click(e=>{this.keepSelection(),e.stopPropagation()}),$("#poptranslate-lang").change(e=>this.action("changeLanguage",$(e.target).val())),$("#poptranslate-btn-speak").click(()=>this.action("speakText",$("#poptranslate-word").text())),$("html").on("keyup",e=>{"Escape"===e.originalEvent.code&&(this.action("close"),this.sendGA(["_trackEvent","App","Close"]))}),$("code.hljs,pre.hljs").on("click",e=>{const t=e.target.classList.contains("hljs")?e.target:this.getAncestorTag(e.target,".hljs"),o=document.createElement("textarea");o.value=t.textContent,document.body.appendChild(o),o.select(),document.execCommand("copy"),o.remove(),this.alert("ok","Code copied")}),$("#content").on("click","a",e=>this.handleClick(e)),window.addEventListener("scroll",this.calcOutlinePos)}message(e,...t){return CLEARLY_MESSAGE.get(e,this.system&&this.system.lang||"en",...t)}brushMessages(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);for(;e.nextNode();){const t=e.currentNode.nodeValue;t.includes("{{")&&t.includes("}}")&&(e.currentNode.nodeValue=t.replace(/{{([\w.]+)}}/gi,(e,t)=>this.message(t)))}}calcOutlinePos(){const e=document.querySelectorAll(".ros");let t=null;for(let o=0;o<e.length;o++){if(!(e[o].getBoundingClientRect().top<100))break;t=e[o]}if(t){const e=t.getAttribute("id"),o=e&&e.startsWith("ros-")?e.split("-").pop():0,n=document.querySelector(`#outline-ros-${o}`);if(n&&!n.classList.contains("outline-active")){const e=document.querySelectorAll(".outline-section");for(let t=0;t<e.length;t++)String(t)===String(o)?e[t].classList.add("outline-active"):e[t].classList.remove("outline-active")}}}handleChange(e){const t=$(e.currentTarget),o=t.val();let n="setState",s=t.attr("bind");s.startsWith("config.")&&(n="setConfig",s=s.substr(7,s.length)),this[n]({[s]:o})}handleEvent(t){const o=$(t.currentTarget).attr(t.type);o&&(e("handleEvent",o),o.split(";").forEach(e=>{let[t,o]=e.split("="),n="setState",s="state";t.startsWith("config.")&&(n="setConfig",t=t.substr(7,t.length),s="config");let a=o;if(o.includes("/"))if("0/1"===o)a=!this[s][t];else{const[e,n]=o.split("/");a=this[s][t]===e?n:e}this[n]({[t]:a},"click")}))}handleParentMessage(e){if(e){if(e.callback)return this.callbackReceive(e.callback,e.result,e.error);switch(e.type){case"UPDATE":this.setState({isReady:!0}),this.show(e,!0)}}}setIcon(e){this.callBackground("updateIcon",{status:e})}async clipArticle(){this.state.clipUrl||fetch("https://api.clearlyreader.com/api/clipArticle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:this.article.title,outline:this.article.outline,html:this.article.content,text:this.article.textContent,url:this.url,uid:"",config:this.config})}).then(e=>e.json()).then(e=>{e&&0===e.code&&e.data?(this.setState({clipUrl:e.data.url}),this.action("copyClipUrl")):this.alert("warn",e.message||"clip failed")})}setState(e,t){this.state||(this.state={}),Object.keys(e).forEach(o=>{const n=this.state[o];this.state[o]=e[o],this.handleState(o,e[o],n,t)})}setConfig(e,t){this.config||(this.config={}),Object.keys(e).forEach(o=>{const n=this.config[o];this.config[o]=e[o],this.handleConfig(o,e[o],n,t)})}getSelectionCharOffsets(){let e,t,o,n=0,s=0;const a=document.querySelector("#content");return void 0!==window.getSelection?((o=(t=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(a),o.setEnd(t.startContainer,t.startOffset),s=(n=o.toString().length)+t.toString().length):void 0!==document.selection&&"Control"!==(e=document.selection).type&&(t=e.createRange(),(o=document.body.createTextRange()).moveToElementText(a),o.setEndPoint("EndToStart",t),s=(n=o.text.length)+t.text.length),{start:n,end:s,length:s-n}}async bootstrap(){let t,o;try{t=JSON.parse($("#config").text())}catch(e){console.error(e),t=await this.callBackground("getConfig")}try{o=JSON.parse($("#params").text())}catch(e){console.error(e)}this.initConfig=t,this.setConfig(t.user,"init"),this.setState({...ClearlyApp.DEFAULT_STATE,...t.clearly.reader,manifestVersion:t.manifest.version,clearlyConfigVersion:t.clearly.version,autoOpen:t.autoOpen,params:o}),this.system=t.system,t.clearly.messages&&"object"==typeof t.clearly.messages&&Object.assign(CLEARLY_MESSAGE.messages,t.clearly.messages),this.getVoices().then(e=>this.setState({voices:e})),this.boot=!0,this.brushMessages(),window.addEventListener("message",t=>{e("Frame received message",t.data),this.handleParentMessage(t.data)},!1)}getVoices(){return new Promise(function(e,t){let o,n=window.speechSynthesis;o=setInterval(()=>{0!==n.getVoices().length&&(e(n.getVoices()),clearInterval(o))},10)})}async shutdown(){window.speechSynthesis.cancel()}}function e(){const e=Array.prototype.slice.call(arguments,0);console.debug.apply(null,["CLEARY* |"].concat(e))}ClearlyApp.DEFAULT_STATE={load:!1,speak:null,speakStartPos:0,speakPos:0,speakMark:!0,speakVoiceMap:{default:"auto"},fullscreen:!1,isReady:!1,isTranslate:!1,translateResult:null,isSharing:!1,clipUrl:null,whitelist:["news.google.com/*","support.google.com/*","medium.com/*","www.jianshu.com/p/*"],blacklist:["www.youtube.com/*","www.google.*","chrome.google.com/*","accounts.google.com/*","myaccount.google.com/*","translate.google.com/*","mail.google.com/*","drive.google.com/*","docs.google.com/*","spreadsheet.google.com/*"],fonts:[{name:"System",system:["win","mac"]},{name:"Lora",system:["win","mac"]},{name:"NotoSerif",system:["win","mac"]},{name:"Crimson Text",system:["win","mac"]},{name:"Georgia",system:["win","mac"]},{name:"Roboto",system:["win","mac"]},{name:"STKaiti",system:["win","mac"]},{name:"STSong",system:["win","mac"]}],themes:[{theme:"default",autoTheme:"day",mainColor:"#ffffff",bgColor:"#f1f3f4",fontColor:"#191919",linkColor:"#000000"},{theme:"yellow",autoTheme:"day",mainColor:"#f8f1e3",bgColor:"#efe4ce",fontColor:"#4f321c",linkColor:"#3f2816"},{theme:"green",autoTheme:"day",mainColor:"#CEE0D5",bgColor:"#C2D3C9",fontColor:"#333333",linkColor:"#333333"},{theme:"gray",autoTheme:"night",mainColor:"#4a4a4d",bgColor:"#323233",fontColor:"#eeeeee",linkColor:"#ffffff"},{theme:"black",autoTheme:"night",mainColor:"#121212",bgColor:"#060606",fontColor:"#eeeeee",linkColor:"#ffffff"}]},window.clearlyApp=new ClearlyApp,window.clearlyApp.bootstrap(),window.onbeforeunload=(e=>{window.clearlyApp.shutdown()});