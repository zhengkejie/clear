const ClearlyEnv=window.ClearlyEnv||{};class ClearlyContent{static toggle(){ClearlyContent.isOpen()?ClearlyContent.close():ClearlyContent.open()}static stopKeyZoom(e){(e.metaKey||e.ctrlKey)&&[48,61,96,107,109,187,189].indexOf(e.keyCode)>-1&&e.preventDefault()}static async open(e){e=e||{},ClearlyContent._isSupported&&(e.auto&&!ClearlyContent.getArticle()||(ClearlyContent._init||await ClearlyContent.init(e),document.documentElement.classList.add("clearly-overflow"),document.body.classList.add("clearly-enabled"),document.getElementById("clearly-container").style.display="inherit",ClearlyContent.callBackground("updateIcon",{status:"active"}),ClearlyContent.updateFavicon(),document.addEventListener("keydown",e=>ClearlyContent.stopKeyZoom(e))))}static close(){document.documentElement.classList.remove("clearly-overflow"),document.body.classList.remove("clearly-enabled"),document.getElementById("clearly-container").style.display="none",ClearlyContent.restoreFavicon(),ClearlyContent.callBackground("updateIcon",{status:"readable"}),ClearlyContent.callBackground("speakStop"),document.removeEventListener("keydown",e=>ClearlyContent.stopKeyZoom(e))}static isOpen(){const e=document.getElementById("clearly-container");return e&&"none"!==e.style.display}static updateFavicon(){const e=document.querySelectorAll('link[rel*="icon"]');let t=null;if(e.length>0&&e.forEach(e=>{null===t&&(t=e.href),"shortcut icon"===e.getAttribute("rel")&&(t=!1),e.setAttribute("data-href",e.href),e.href=chrome.runtime.getURL("/assets/icons/active/ic_128.png")}),t){const e=document.createElement("link");e.rel="shortcut icon",e.setAttribute("data-href",t),e.href=chrome.runtime.getURL("/assets/icons/active/ic_128.png"),document.getElementsByTagName("head")[0].appendChild(e)}}static restoreFavicon(){document.querySelectorAll("link[rel*='icon']").forEach(e=>{e.href=e.getAttribute("data-href"),e.removeAttribute("data-href")})}static sendFrame(t){e("sendFrame",t,!!ClearlyContent.frameEl),ClearlyContent.frameEl&&ClearlyContent.frameEl.contentWindow.postMessage(t,"*")}static getClearly(){return ClearlyContent.clearly||(ClearlyContent.clearly=new Clearly(document.cloneNode(!0),{root:document,debug:ClearlyEnv.debug},this.config&&this.config.clearly?this.config.clearly.readability:null)),ClearlyContent.clearly}static getArticle(e){return ClearlyContent.article&&!e&&ClearlyContent.article.url===window.location.href||(ClearlyContent.article=ClearlyContent.getClearly().parse()),ClearlyContent.article}static update(){e("update"),ClearlyContent.sendFrame({type:"UPDATE",url:window.location.href,article:ClearlyContent.getArticle()})}static async init(t){if(!ClearlyContent._isSupported||ClearlyContent._init)return;ClearlyContent._init=!0;const n=chrome.extension.getURL("/pages/content/app.html"),a=chrome.extension.getURL("/"),c=(await(await window.fetch(n)).text()).replace(/(src|href)="\//g,`$1="${a}`).replace("\x3c!-- clearly placeholder --\x3e",`<textarea id="config" style="display:none">${JSON.stringify(this.config)}</textarea><textarea id="env" style="display:none">${JSON.stringify(ClearlyEnv)}</textarea><textarea id="params" style="display:none">${JSON.stringify(t||{})}</textarea>`),l=document.createElement("iframe");l.allowFullscreen=!0,l.src=`data:text/html;charset=utf-8, ${escape(c)}`,l.style.display="none",l.id="clearly-container",l.referrerPolicy="origin-when-cross-origin",l.onload=(()=>{e("frame load"),l.contentWindow.focus(),ClearlyContent.update()}),document.body.appendChild(l),ClearlyContent.frameEl=l}static remove(){document.body.removeChild(this.frameEl),document.body.removeChild(this.styleEl),ClearlyContent.frameEl=null,ClearlyContent.styleEl=null}static callBackground(t,n){return new Promise((a,c)=>{chrome.runtime.sendMessage({...n||{},type:t},n=>{const{error:l,result:o}=n||{};return chrome.runtime.lastError?(e(`call ${t} failed with runtime error`),a()):l?c(l):void a(o)})})}static fullscreen(e){const t=ClearlyContent.frameEl;if(e.fullscreen){const e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||!1;e&&e.call(t)}else{(document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen).call(document)}}static handleFrameMessage(t){e("handleFrameMessage",t),"function"==typeof ClearlyContent[t.type]&&ClearlyContent[t.type].call(null,t)}static isSupportUrl(e,t){const n=ClearlyContent.urlToRegexp(e.blacklist);return!!ClearlyContent.urlToRegexp(e.whitelist).some(e=>e.test(t))||!n.some(e=>e.test(t))}static urlToRegexp(e){return e.map(e=>{const t=e.replace(/[-[]\/\{\}\(\)\+\?\.\\\^\$\|]/g,"\\$&").replace(/\*/g,".*?").replace(/^http:\\\/\\\/\.\*/i,"http:\\/\\/[^/]*").replace(/^https:\\\/\\\/\.\*/i,"https:\\/\\/[^/]*");return new RegExp(t,"i")})}static removeTip(){document.getElementById("clearly-content-container").remove()}static injectCss(){const e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.id="clearly-content-css",e.href=chrome.runtime.getURL("/pages/content/content.css"),document.getElementsByTagName("head")[0].appendChild(e)}static message(e){return CLEARLY_MESSAGE.get(e,this.config&&this.config.system.lang||"en")}static addTip(){const e=document.createElement("template");function t(){ClearlyContent.tipTimer=setTimeout(e=>{ClearlyContent.removeTip()},3e3)}e.innerHTML=`<div id="clearly-content-container">\n      <div id="clearly-content-btn-open" class="clearly-content-tip-btn">${ClearlyContent.message("content.tip.open")}</div>\n      <div id="clearly-content-btn-setting" class="clearly-content-tip-btn setting"></div>\n      <div id="clearly-content-btn-dismiss" class="clearly-content-tip-btn"></div>\n    </div>`,document.body.appendChild(e.content.firstChild),document.getElementById("clearly-content-btn-open").addEventListener("click",()=>{ClearlyContent.open(),ClearlyContent.removeTip()}),document.getElementById("clearly-content-btn-dismiss").addEventListener("click",()=>{ClearlyContent.removeTip()}),document.getElementById("clearly-content-btn-setting").addEventListener("click",()=>{ClearlyContent.open({showDialog:"setting"}),ClearlyContent.removeTip()}),document.getElementById("clearly-content-container").addEventListener("mousemove",()=>{ClearlyContent.tipTimer&&(clearTimeout(ClearlyContent.tipTimer),ClearlyContent.tipTimer=null)}),document.getElementById("clearly-content-container").addEventListener("mouseout",()=>{ClearlyContent.tipTimer||t()}),t()}static async bootstrap(t){if(this.config=await ClearlyContent.callBackground("getConfig",{url:window.location.href}),ClearlyContent._isSupported=!0,!t&&this.config&&this.config.clearly&&(!document.contentType.includes("/html")||!ClearlyContent.isSupportUrl(this.config.clearly.reader,window.location.href)))return ClearlyContent._isSupported=!1,void ClearlyContent.callBackground("updateIcon",{status:"disable"});ClearlyContent.injectCss(),ClearlyContent.callBackground("updateIcon",{status:"readable"}),window.addEventListener("message",async function(t){const n=t.data;if(n&&n.type)if(e("Window Message",n),n.background){let t,a;e("Send to background",n);try{t=await ClearlyContent.callBackground(n.type,n)}catch(e){a=e.message}n.callback&&ClearlyContent.sendFrame({callback:n.callback,result:t,error:a})}else ClearlyContent.handleFrameMessage(n)},!1),window.onbeforeunload=(()=>{ClearlyContent.restoreFavicon()}),chrome.runtime.onMessage.addListener(function(e,t,n){e.frame&&ClearlyContent.sendFrame(e)}),window.location.href.includes("#clearly")||this.config.autoOpen&&this.config.autoOpen.mode?(e("open automatically"),ClearlyContent.open({auto:!0})):this.config.user&&this.config.user.openTip&&ClearlyContent.getClearly().isProbablyReaderable()&&ClearlyContent.addTip()}}function e(){if(!ClearlyEnv.debug)return;const e=Array.prototype.slice.call(arguments,0);console.debug.apply(null,["[CLEARY/CONTENT] "].concat(e))}ClearlyContent.bootstrap();