var e=[];e.push(["_setAccount","UA-92398359-4"]),e.push(["_set","page","/extension/"+chrome.runtime.getManifest().version+"/background"]),e.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();const t={version:chrome.runtime.getManifest().version,whitelist:["news.google.com/*","support.google.com/*","medium.com/*","www.jianshu.com/p/*"],blacklist:["www.youtube.com/*","www.google.*","chrome.google.com/*","accounts.google.com/*","myaccount.google.com/*","translate.google.com/*","mail.google.com/*","drive.google.com/*","docs.google.com/*","spreadsheet.google.com/*"],fonts:[{name:"Lora",lang:["en"],default:"en",system:["win","mac"]},{name:"NotoSerif",lang:["en"],system:["win","mac"]},{name:"Crimson Text",lang:["en"],system:["win","mac"]},{name:"Georgia",lang:["en"],system:["win","mac"]},{name:"Roboto",lang:["en"],system:["win","mac"]},{name:"Kaiti",lang:["zh"],default:"zh",system:["win","mac"]},{name:"Songti",lang:["zh"],system:["win","mac"]},{name:"System",lang:["zh","en"],system:["win","mac"]}]};class s{async speakStart(e){if(!e.text||!e.tabId)return void console.error("text or tabId not found");return await chrome.tts.isSpeaking()&&chrome.tts.stop(),this.speakState="start",this.speakTabId=e.tabId,new Promise((t,s)=>{this.detectLanguage({tabId:this.speakTabId}).then(a=>{if(!chrome.tts)return s(new Error("no tts fount"));chrome.tts.stop(),chrome.tts.speak(e.text,{lang:a,rate:Number(e.rate||"1"),voiceName:this.getVoiceName(e.voiceName,a),onEvent:e=>{switch(e.type){case"end":this.speakState=null,this.sendToFrame({type:"SPEAK",speak:"STOP"});break;case"interrupted":case"cancelled":case"error":this.speakState=null;break;case"word":this.sendToFrame({type:"SPEAK_WORD",charIndex:e.charIndex,length:e.length})}},...e.options},e=>{chrome.runtime.lastError&&s(new Error("runtime error")),t()})})})}getVoiceName(e,t){if("auto"===e||!e)return null;if("google"===e){const e=this.speakVoices.find(e=>e.lang===t&&e.voiceName.startsWith("Google"));return e?e.voiceName:null}return e}speakPause(){chrome.tts&&(this.speakState="pause",chrome.tts.pause())}speakResume(){chrome.tts&&(this.speakState="start",chrome.tts.resume())}speakStop(){chrome.tts&&(this.speakState=null,chrome.tts.stop())}sendToFrame(e){this.speakTabId&&chrome.tabs.get(this.speakTabId,t=>{t?(chrome.tabs.sendMessage(this.speakTabId,{...e,frame:!0}),chrome.runtime.lastError&&debug("lastError",chrome.runtime.lastError.message)):console.warn(`tab ${this.speakTabId}`)})}getSpeakVoices(){return new Promise((e,t)=>{if(this.speakVoices)return e(this.speakVoices);chrome.tts.getVoices(s=>{chrome.runtime.lastError?t(new Error("runtime error: "+chrome.runtime.lastError)):(this.speakVoices=s,console.log("voice: ",s),e(s))})})}async getConfig({tabId:e}){const s={theme:"default",zoom:1,outline:!0,themeDay:"default",themeNight:"gray",themeAuto:!1,syntax:!0,width:2,background:!0,linkOpenNew:!0,translateLang:navigator.language,clearly:t,speakRate:"1",lang:await this.detectLanguage({tabId:e}),voices:await this.getSpeakVoices(),speakVoiceMap:{default:"auto"},speakPitch:1,readUpdates:!1};return new Promise((e,t)=>{chrome.storage.local.get(["config"],t=>{Object.assign(s,t.config||{}),e(s)})})}saveConfig({config:e}){return!!e&&(delete e.clearly,delete e.lang,delete e.tabId,delete e.voices,delete e.voice,delete e.speakVoice,new Promise((t,s)=>{chrome.storage.local.set({config:e},e=>{t(!0)})}))}submitArticle(e){return this.callApi("submitArticle",e)}submitFeedback(e){return this.callApi("submitFeedback",e)}getWiki(e){return this.callApi("card/wiki",e)}getSearch(e){return this.callApi("card/search",e)}getTranslate(e){return this.callApi("card/translate",e)}updateIcon({status:e,tabId:t}){e=e||"default",chrome.browserAction.setIcon({path:{16:`/assets/icons/${e}/ic_16.png`,32:`/assets/icons/${e}/ic_32.png`,48:`/assets/icons/${e}/ic_48.png`,128:`/assets/icons/${e}/ic_128.png`},tabId:t})}translate({text:e,lang:t}){let a=s.hashCode(JSON.stringify({text:e,lang:t})),r=this.translateResults.get(a);return r||fetch(`https://translate.googleapis.com/translate_a/single?dt=t&dt=bd&dt=qc&dt=rm&client=gtx&sl=auto&tl=${t}&q=${encodeURIComponent(e)}&hl=en-US&dj=1&tk=${s.googleToken()}`,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>e.json()).then(e=>(this.translateResults.set(a,e),e))}ga({data:t}){void 0!==e&&e.push(t)}detectLanguage({tabId:e}){return new Promise((t,s)=>{chrome.tabs.detectLanguage(e,e=>{chrome.runtime.lastError&&t(null),t(e)})})}toggle(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){e[0]&&e[0].url.startsWith("http")&&chrome.tabs.executeScript(null,{code:"try{ClearlyContent.toggle()}catch(err){console.debug('Open clearly failed', err)}"})})}callApi(e,t){return fetch(`https://clearlyreader.com/api/${e}`,{method:"POST",body:JSON.stringify(t),headers:{"content-type":"application/json"}}).then(e=>e.json()).then(e=>{if(0!==e.code)throw new Error(`api error ${e.code}`);return e.data})}handleMessage(e,t,s){console.debug("handleMessage",e);const a=t.tab&&t.tab.id;if("function"==typeof this[e.type]){const t=this[e.type]({...e,tabId:a});if(t instanceof Promise)return t.then(e=>s({result:e})).catch(e=>s({error:e.message})),!0;s(t)}}registerChromeHandlers(){this.manifest=chrome.runtime.getManifest(),this.translateResults=new LRUMap(200),chrome.tts&&chrome.tts.isSpeaking(e=>{e&&e.length&&chrome.tts.stop()}),chrome.contextMenus.create({title:"Toggle Clearly",onclick:this.toggle,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({title:"Open with Clearly",contexts:["link"],onclick:(e,t)=>{chrome.tabs.create({url:e.linkUrl+"#clearly"})}}),chrome.commands.onCommand.addListener(e=>{switch(e){case"toggle":this.toggle()}}),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.browserAction.onClicked.addListener(()=>this.toggle()),chrome.tabs.query({lastFocusedWindow:!0,active:!0},e=>{e[0]&&(this.currentTabId=e[0].id)}),chrome.tabs.onUpdated.addListener((e,t)=>{console.debug("TAB UPDATE",{tabId:e,changeInfo:t}),"loading"===t.status&&e===this.speakTabId&&this.speakStop({force:!0})}),chrome.tabs.onRemoved.addListener(e=>{console.debug("TAB REMOVE",{tabId:e}),e===this.speakTabId&&this.speakStop({force:!0})}),chrome.tabs.onActivated.addListener(e=>{console.debug("TAB ACTIVATED",e),this.currentTabId=e.tabId}),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason?chrome.tabs.create({url:"https://clearlyreader.com/r/install?v="+this.manifest.version,selected:!0}):e.reason}),chrome.runtime.setUninstallURL("https://clearlyreader.com/r/uninstall?v="+this.manifest.version)}static googleToken(){return Math.random().toString().substr(2,7)+"."+Math.random().toString().substr(2,7)}static hashCode(e){let t,s,a=0;if(0===e.length)return a;for(t=0;t<e.length;t++)a=(a<<5)-a+(s=e.charCodeAt(t)),a|=0;return a}static bootstrap(){const e=new s(window);return e.registerChromeHandlers(),e}}window.background=s.bootstrap();