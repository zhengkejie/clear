const ClearlyEnv=window.ClearlyEnv||{};class ClearlyContent{static toggle(){ClearlyContent.isOpen()?ClearlyContent.close():ClearlyContent.open()}static stopKeyZoom(e){(e.metaKey||e.ctrlKey)&&[48,61,96,107,109,187,189].indexOf(e.keyCode)>-1&&e.preventDefault()}static async open(e){ClearlyContent._isSupported&&(e&&!ClearlyContent.getArticle()||(ClearlyContent._init||await ClearlyContent.init(),document.documentElement.classList.add("clearly-overflow"),document.body.classList.add("clearly-enabled"),document.getElementById("clearly-container").style.display="inherit",ClearlyContent.callBackground("updateIcon",{status:"active"}),ClearlyContent.updateFavicon(),document.addEventListener("keydown",e=>ClearlyContent.stopKeyZoom(e))))}static close(){document.documentElement.classList.remove("clearly-overflow"),document.body.classList.remove("clearly-enabled"),document.getElementById("clearly-container").style.display="none",ClearlyContent.restoreFavicon(),ClearlyContent.callBackground("updateIcon",{status:"readable"}),ClearlyContent.callBackground("speakStop"),document.removeEventListener("keydown",e=>ClearlyContent.stopKeyZoom(e))}static isOpen(){const e=document.getElementById("clearly-container");return e&&"none"!==e.style.display}static updateFavicon(){const e=document.querySelectorAll('link[rel*="icon"]');let t=null;if(e.length>0&&e.forEach(e=>{null===t&&(t=e.href),"shortcut icon"===e.getAttribute("rel")&&(t=!1),e.setAttribute("data-href",e.href),e.href=chrome.runtime.getURL("/assets/icons/active/ic_128.png")}),t){const e=document.createElement("link");e.rel="shortcut icon",e.setAttribute("data-href",t),e.href=chrome.runtime.getURL("/assets/icons/active/ic_128.png"),document.getElementsByTagName("head")[0].appendChild(e)}}static restoreFavicon(){document.querySelectorAll("link[rel*='icon']").forEach(e=>{e.href=e.getAttribute("data-href"),e.removeAttribute("data-href")})}static sendFrame(t){e("sendFrame",t,!!ClearlyContent.frameEl),ClearlyContent.frameEl&&ClearlyContent.frameEl.contentWindow.postMessage(t,"*")}static getArticle(e){return ClearlyContent.article&&!e&&ClearlyContent.article.url===window.location.href||(ClearlyContent.article=new Clearly(document.cloneNode(!0),{root:document,debug:ClearlyEnv.debug}).parse()),ClearlyContent.article}static update(){e("update"),ClearlyContent.sendFrame({type:"UPDATE",url:window.location.href,article:ClearlyContent.getArticle()})}static async init(){if(!ClearlyContent._isSupported||ClearlyContent._init)return;ClearlyContent._init=!0;const t=this.config,n=chrome.extension.getURL("/pages/content/app.html"),a=chrome.extension.getURL("/"),o=(await(await window.fetch(n)).text()).replace(/(src|href)="\//g,`$1="${a}`).replace("\x3c!-- clearly placeholder --\x3e",`<textarea id="config" style="display:none">${JSON.stringify(t)}</textarea><textarea id="env" style="display:none">${JSON.stringify(ClearlyEnv)}</textarea>`),r=document.createElement("iframe");r.allowFullscreen=!0,r.src=`data:text/html;charset=utf-8, ${escape(o)}`,r.style.display="none",r.id="clearly-container",r.referrerPolicy="origin-when-cross-origin",r.onload=(()=>{e("frame load"),r.contentWindow.focus(),ClearlyContent.update()});const l=document.createElement("style");l.innerHTML="\n\n\n.clearly-overflow {\n  overflow: hidden !important;\n}\n.clearly-enabled {\n  overflow: hidden !important;\n}\n\niframe#clearly-container {\n  position: fixed !important;\n  top: 0;\n  right: 0;\n  width: 100% !important;\n  height: 100% !important;\n  max-width: 100% !important;\n  max-height: 100% !important;\n  border: none;\n  overflow: auto;\n  display: none !important;\n  z-index: 2147483647;\n}\n\n.clearly-enabled iframe#clearly-container {\n  display: block !important;\n}\n",document.body.appendChild(r),document.body.appendChild(l),ClearlyContent.frameEl=r,ClearlyContent.styleEl=l}static remove(){document.body.removeChild(this.frameEl),document.body.removeChild(this.styleEl),ClearlyContent.frameEl=null,ClearlyContent.styleEl=null}static callBackground(t,n){return new Promise((a,o)=>{chrome.runtime.sendMessage({...n||{},type:t},n=>{const{error:r,result:l}=n||{};return chrome.runtime.lastError?(e(`call ${t} failed with runtime error`),a()):r?o(r):void a(l)})})}static fullscreen(e){const t=ClearlyContent.frameEl;if(e.fullscreen){const e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||!1;e&&e.call(t)}else{(document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen).call(document)}}static handleFrameMessage(t){e("handleFrameMessage",t),"function"==typeof ClearlyContent[t.type]&&ClearlyContent[t.type].call(null,t)}static isSupportUrl(e,t){const n=ClearlyContent.urlToRegexp(e.blacklist);return!!ClearlyContent.urlToRegexp(e.whitelist).some(e=>e.test(t))||!n.some(e=>e.test(t))}static urlToRegexp(e){return e.map(e=>{const t=e.replace(/[-[]\/\{\}\(\)\+\?\.\\\^\$\|]/g,"\\$&").replace(/\*/g,".*?").replace(/^http:\\\/\\\/\.\*/i,"http:\\/\\/[^/]*").replace(/^https:\\\/\\\/\.\*/i,"https:\\/\\/[^/]*");return new RegExp(t,"i")})}static async bootstrap(t){const n=this.config=await ClearlyContent.callBackground("getConfig");if(ClearlyContent._isSupported=!0,!t&&(!document.contentType.includes("/html")||n&&!ClearlyContent.isSupportUrl(n.clearly,window.location.href)))return ClearlyContent._isSupported=!1,void ClearlyContent.callBackground("updateIcon",{status:"disable"});ClearlyContent.callBackground("updateIcon",{status:"readable"}),window.addEventListener("message",async function(t){const n=t.data;if(n&&n.type)if(e("Window Message",n),n.background){let t,a;e("Send to background",n);try{t=await ClearlyContent.callBackground(n.type,n)}catch(e){a=e.message}n.callback&&ClearlyContent.sendFrame({callback:n.callback,result:t,error:a})}else ClearlyContent.handleFrameMessage(n)},!1),window.onbeforeunload=(()=>{ClearlyContent.restoreFavicon()}),chrome.runtime.onMessage.addListener(function(e,t,n){e.frame&&ClearlyContent.sendFrame(e)}),window.location.href.includes("#clearly")&&(e("open automatically"),ClearlyContent.open(!0))}}function e(){if(!ClearlyEnv.debug)return;const e=Array.prototype.slice.call(arguments,0);console.debug.apply(null,["[CLEARY/CONTENT] "].concat(e))}ClearlyContent.bootstrap();