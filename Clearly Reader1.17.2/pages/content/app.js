function e(){const e=Array.prototype.slice.call(arguments,0);console.debug.apply(null,["CLEARY* |"].concat(e))}(window.clearlyApp=new class{constructor(){this.callbackStart(),this.state={},this.config={}}load(e,t){if(!this.boot&&!t)return!1;this.setState({isReady:!0});const a=this.article=e.article;return this.url=e.url,$("#footer").show(),this.renderArticle(a),!!this.article&&(a.outline&&a.outline.length&&""!==a.outline[0].id&&a.outline.unshift({title:a.title,id:"ros-0",type:"h1"}),a.outline&&($("#outlines").html(DOMPurify.sanitize(a.outline.map(e=>'<li id="outline-'+e.id+'" class="outline-section outline-'+e.type+'"><a href="javascript:;" data-id="#'+e.id+'">'+e.title+"</a></li>").join("\n"),{SAFE_FOR_JQUERY:!0})),a.outline.length||$("#switch-outline").addClass("s-disable")),a.links&&a.links.length>0&&($("#links").html(DOMPurify.sanitize(a.links.filter(e=>"text"===e.type).map(e=>`<li class="links-item"><a href="${e.url}">${e.title}</a></li>`).join("\n"),{SAFE_FOR_JQUERY:!0})),$("#links-container").show()),$("#btn-cantact").attr("href","https://clearlyreader.com/r/report?url="+encodeURIComponent(this.url)),this.afterInit(),!0)}renderArticle(e){if(e)$("#container").html(DOMPurify.sanitize(`<div id="subject">${e.title}</div><div id="cover" style="background-image:${e.coverUrl?"url('"+e.coverUrl+"')":"none;display:none"}"></div><div id="byline">${e.authorName?e.authorName+" @"+e.hostname:""}</div><div id="content">${e.content}</div>`,{SAFE_FOR_JQUERY:!0,ALLOWED_ATTR:["id","style","src","alt","href","class","srcset","title"]})),this.speakContent=this.article.textContent;else{const e=this.getQuotes(),t=e[Math.floor(Math.random()*e.length)],[a,s]=t.split(" – ");$("#container").html(DOMPurify.sanitize(`<div id="title"></div><div id="cover"></div><div id="byline"></div><div id="#content"><div class="quote"><div class="quote-text">${a}</div><div class="quote-author">${s}</div></div></div>`,{SAFE_FOR_JQUERY:!0}))}}afterInit(){window.hljs&&this.config.syntax&&(hljs.configure({ignoreUnescapedHTML:!0}),document.querySelectorAll("pre,code").forEach(e=>{e.classList.contains("hljs")||e.childNodes[0]&&"CODE"===e.childNodes[0].tagName||hljs.highlightElement(e)}));const e=document.querySelector("#content");this.speakMarker=new Mark(e),this.bindEvents()}getQuotes(){return["“A reader lives a thousand lives before he dies . . . The man who never reads lives only one.” – George R.R. Martin,","“Until I feared I would lose it, I never loved to read. One does not love breathing.” – Harper Lee","“Never trust anyone who has not brought a book with them.” – Lemony Snicket","“You can never get a cup of tea large enough or a book long enough to suit me.” – C.S. Lewis","“Reading is essential for those who seek to rise above the ordinary.” – Jim Rohn","“I find television very educating. Every time somebody turns on the set, I go into the other room and read a book.” – Groucho Marx","“‘Classic’, a book which people praise and don’t read.” – Mark Twain","“You don’t have to burn books to destroy a culture. Just get people to stop reading them.” – Ray Bradbury","“So please, oh please, we beg, we pray, go throw your TV set away, and in its place you can install a lovely bookshelf on the wall.” – Roald Dahl","“Think before you speak. Read before you think.” – Fran Lebowitz","“Let’s be reasonable and add an eighth day to the week that is devoted exclusively to reading.” – Lena Dunham","“The reading of all good books is like conversation with the finest (people) of the past centuries.” – Descartes","“In the case of good books, the point is not to see how many of them you can get through, but rather how many can get through to you.” – Mortimer J. Adler","“Reading one book is like eating one potato chip.” – Diane Duane","“The more that you read, the more things you will know. The more that you learn, the more places you’ll go.” – Dr. Seuss","Like Dr. Suess? Want to see our entire collection of quotes from Dr. Suess?","“Books are a uniquely portable magic.” – Stephen King","“I read a book one day and my whole life was changed.” – Orhan Pamuk","“People say that life is the thing, but I prefer reading.” – Logan Pearsall Smith","“Today a reader, tomorrow a leader.” – Margaret Fuller","“People can lose their lives in libraries. They ought to be warned.” – Saul Bellow"]}closePopmenu(e){this.lastSelection=null,this.setState({popupOverlayData:null}),$("#popmenu").hide(),$("#poptranslate").hide(),$("#popshare").hide(),$("body").off("click",this.closePopmenu.bind(this))}clickPopmenu(e){const t=window.getSelection().toString();if(t){switch(this.lastSelectedText=t,e){case"translate":this.startPopTranslate(t);break;case"copy":document.execCommand("copy"),this.closePopmenu();break;case"search":this.callBackground("getSearch",{keyword:t}).then(e=>this.showPopmenuOverlay({type:"search",data:e}));break;case"wiki":this.callBackground("getWiki",{text:t}).then(e=>this.showPopmenuOverlay({type:"wiki",data:e}));break;case"share":html2canvas(document.querySelector("#root")).then(e=>{document.body.appendChild(e)});break;case"highlight":highlightSelection(),this.closePopmenu(),window.getSelection().empty()}this.sendGA(["_trackEvent","CHROME_APP","POP_"+e.toUpperCase()])}}showPopmenuOverlay(e){this.setState({popupOverlayData:e})}keepSelection(){if(!this.lastSelection)return;let e=window.getSelection(),t=e.toString(),a=this.lastSelection.ranges;t&&e.removeAllRanges();for(let t=0,s=a.length;t<s;++t)e.addRange(a[t])}async startPopTranslate(t){try{const a=await this.translate(t,this.config.translateLang);this.showPopmenuTranslate(a)}catch(t){e("error",t)}}showPopmenu(){const e=this.lastSelection&&this.lastSelection.position;e&&($("#poptranslate").hide(),$("#popmenu").show(),$("#popmenu").css({left:(window.pageXOffset+e.x+(e.width-$("#popmenu").width())/2)*parseFloat(this.config.zoom||1),top:(window.pageYOffset+e.y-$("#popmenu").height()-10)*parseFloat(this.config.zoom||1)}),setTimeout(()=>{$("body").on("click",this.closePopmenu.bind(this))},100))}showClearlyBtn(e){const t=e.target,a=t.getAttribute("href");if(t&&"A"===t.nodeName&&a&&a.startsWith("http")){const s=t.getBoundingClientRect();let o=window.pageYOffset+s.y-s.height+6,n=e.pageX-12.5;s.height>27&&(o+=30),e.pageY-o>50&&(o+=30),$("#clearly-btn").show(),$("#clearly-btn").css({left:n,top:o}),$("#clearly-btn").data("url",a)}else"clearly-btn"!==e.target.getAttribute("id")&&$("#clearly-btn").hide()}openClearlyBtn(){const e=$("#clearly-btn").data("url");e&&window.open(e+"#clearly","_blank"),this.sendGA(["_trackEvent","CHROME_APP","CLICK_CLEARLY_BTN"])}handleClick(e){e.preventDefault();const t=e.target.getAttribute("href");t&&t.startsWith("http")&&(this.config.linkOpenNew?window.open(t,"_blank"):location.href=t)}showPopmenuTranslate(e){let t=this.lastSelection.position;if($("#popmenu").hide(),$("#poptranslate").show(),e){let t=e.sentences.map(e=>e.trans||"").join("");if($("#poptranslate-explain").html(t),$("#poptranslate-voice").hide(),e.dict){$("#poptranslate").addClass("poptranslate-wordmode");let t=e.sentences.find(e=>e.translit);t.src_translit&&($("#poptranslate-voice span").html(`[${t.src_translit}]`),$("#poptranslate-voice").show()),$("#poptranslate-translit").html(t.translit||""),$("#poptranslate-word").html(this.lastSelection.text);let a=e.dict.map(e=>`${e.pos[0]}. ${e.terms.join("; ")}`).join("<br />");$("#poptranslate-dict").html(a)}else $("#poptranslate").removeClass("poptranslate-wordmode")}else $("#poptranslate-explain").html("翻译服务未正常工作");$("#poptranslate").css({left:window.pageXOffset+t.x+(t.width-$("#poptranslate").width())/2,top:window.pageYOffset+t.y-$("#poptranslate").height()-30})}getAndSaveSelection(){let e=window.getSelection(),t=e.toString();if(!t)return!1;let a=[];if(e.rangeCount)for(let t=0,s=e.rangeCount;t<s;++t)a.push(e.getRangeAt(t));return this.lastSelection={ranges:a,text:t,position:e.getRangeAt(0).getBoundingClientRect()},!0}show(e,t){if(!this.load(e,t))return;let a;try{a=new URL(this.article.url).hostname}catch(e){}this.sendGA(["_trackEvent","CHROME_APP","APP_SHOW","SITE_"+a])}action(e,t){switch(e){case"close":this.callParent({type:"fullscreen",fullscreen:!1}),this.callParent({type:"close"}),this.stopAll();break;case"share":this.setState({isSharing:t}),this.callBackground("submitFeedback",{article:this.article,feedback:t.toUpperCase()});break;case"toggleOutline":this.article&&this.article.outline.length>0&&this.setConfig({outline:!this.config.outline});break;case"toggleAutotheme":this.setConfig({themeAuto:!this.config.themeAuto});break;case"toggleLinkOpenNew":this.setConfig({linkOpenNew:!this.config.linkOpenNew});break;case"toggleBackground":this.setConfig({background:!this.config.background});break;case"toggleSyntax":this.setConfig({syntax:!this.config.syntax});break;case"zoomIn":this.setConfig({zoom:((parseFloat(this.config.zoom,10)||1)-.1).toFixed(2)});break;case"zoomOut":this.setConfig({zoom:((parseFloat(this.config.zoom,10)||1)+.1).toFixed(2)});break;case"increseWidth":let a=(parseInt(this.config.width,10)||0)+1;a<5&&a>=0&&this.setConfig({width:a});break;case"decreseWidth":let s=(parseInt(this.config.width,10)||0)-1;s<5&&s>=0&&this.setConfig({width:s});break;case"exportDoc":const o=["<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>导出为Word</title></head><body>","<h1>"+this.article.title+"</h1>",document.getElementById("content").getElementsByTagName("article")[0].innerHTML,"</body></html>"].join(""),n=document.createElement("a");n.setAttribute("download",this.article.title+".doc"),n.setAttribute("href","data:application/vnd.ms-word;charset=utf-8,"+encodeURIComponent(o)),n.click();break;case"exportMarkdown":const i=document.createElement("a");i.setAttribute("download",this.article.title+".md"),i.setAttribute("href","data:plain/txt;charset=utf-8,p"+encodeURIComponent(this.covertMarkdown())),i.click();break;case"copyMarkdown":const l=document.createElement("textarea");l.value=this.covertMarkdown(),document.body.appendChild(l),l.select(),document.execCommand("Copy"),l.remove(),this.alert("ok","Markdown 已复制");break;case"copyHTML":const c=document.createElement("textarea");c.value=document.getElementById("content").innerHTML,document.body.appendChild(c),c.select(),document.execCommand("Copy"),c.remove(),this.alert("ok","HTML已复制");break;case"print":window.print();break;case"exportPDF":break;case"copyArticle":const r=document,h=r.getElementById("container");let d,p;r.body.createTextRange?((d=r.body.createTextRange()).moveToElement(h),d.select()):window.getSelection&&(p=window.getSelection(),(d=r.createRange()).selectNodeContents(h),p.removeAllRanges(),p.addRange(d)),document.execCommand("copy"),window.getSelection().removeAllRanges(),this.alert("ok","文章已复制");break;case"theme":this.setConfig({theme:t});break;case"themeDay":this.setConfig({themeDay:t});break;case"themeNight":this.setConfig({themeNight:t});break;case"speakText":this.callBackground("speakStart",{text:t,rate:this.config.speakRate,voiceName:this.config.voice},e=>this.setState({speak:null}));break;case"toggleFullscreenMode":this.setState({fullscreen:!this.state.fullscreen}),this.callParent({type:"fullscreen",fullscreen:this.state.fullscreen});break;case"changeLanguage":this.setConfig({translateLang:t}),this.startPopTranslate(this.lastSelectedText);break;case"font":this.setConfig({[`font_${this.state.lang}`]:t});break;case"report":window.open("https://clearlyreader.com/r/report?url="+encodeURIComponent(this.url))}this.sendGA(["_trackEvent","APP_ACTION","ACTION_"+e.toUpperCase(),"ACTION_"+String(t).toUpperCase()])}covertMarkdown(){const e=new TurndownService;return e.remove("footer"),e.turndown(document.getElementById("main"))}alert(e,t){$("#alert").text(t),$("#alert").attr("class",""),$("#alert").addClass("alert-"+e),$("#alert").show(),setTimeout(e=>$("#alert").hide(),2e3)}handleState(t,a,s,o){if(a!==s)switch(e("handleState",t,a,s),this.handleStateShow(t,a,s),this.handleStateBind(t,a,s),t){case"speak":if(!this.article)return;if("RESTART"===a)return void this.setState({speakStartPos:0,speakPos:0,speak:"START"},o);switch(a){case"PAUSE":$("#menu-speak").addClass("menu-actived"),$("#menu-speak .active").text("volume_off"),"click"===o&&this.callBackground("speakPause"),this.setState({speakStartPos:this.state.speakPos,speakPos:0});break;case"START":case"RESTART":let e;e=this.state.speakStartPos?{text:this.speakContent.substr(this.state.speakStartPos,this.speakContent.length-this.state.speakStartPos),rate:this.config.speakRate,voiceName:this.state.speakVoice,pitch:this.config.speakPitch||1}:{text:this.speakContent,rate:this.config.speakRate,voiceName:this.state.speakVoice,pitch:this.config.speakPitch||1},"click"===o&&this.callBackground("speakStart",e),$("#menu-speak").addClass("menu-actived"),$("#menu-speak .active").text("volume_up");break;case"STOP":case null:$("#menu-speak").removeClass("menu-actived"),$("#menu-speak .active").text("volume_down"),"click"===o&&this.callBackground("speakStop"),this.setState({speakWord:null,speakStartPos:0,speakPos:0})}break;case"fullscreen":a?($("#menu-fullscreen").addClass("menu-actived"),$("#menu-fullscreen .material-icons").text("fullscreen_exit")):($("#menu-fullscreen").removeClass("menu-actived"),$("#menu-fullscreen .material-icons").text("fullscreen"));break;case"isSharing":switch($(".share-overlay").hide(),a){case"yes":$("#share-yes").show();break;case"no":$("#share-no").show();break;case"finish":default:$("#share-default").show()}break;case"isReady":a?($("#loading").hide(),$("#tool").css("display","flex"),$("#container").show()):($("#loading").show(),$("#tool").css("display","none"),$("#container").hide());break;case"showDialog":$(".dialog").removeClass("dialog--open"),$(`#dialog-${a}`).addClass("dialog--open"),"about"===a&&setTimeout(e=>{this.setConfig({readUpdates:this.config.clearly.version})},1e3);break;case"fonts":$("#font-select-style").html(""),a.forEach(e=>{let t=e.name.toLowerCase().replace(/ /g,""),a="font-"+t;this.state&&this.config[`font_${this.state.lang}`]===t&&(a+=" font-selected"),$("#font-select-style").append(DOMPurify.sanitize(`<span data-font="${t}" class="${a}">${e.name}</span>`,{SAFE_FOR_JQUERY:!0}))});break;case"popupOverlayData":if(a){const e=a.data.results.slice(0,5);$("#popmenu-overlay").html(""),e&&e.length?(e.forEach(e=>{$("#popmenu-overlay").prepend(`<a target="clearly-wiki" href="${e.link}"><div class="popmenu-overlay-item">\n            <label>${e.title}</label>\n            <div>${e.intro}</div>\n          </div></a>`)}),$("#popmenu-overlay").append('<div class="popmenu-overlay-footer">Powered by '+("wiki"===a.type?"Wikipedia":"DuckDuckGo")+"</div>")):$("#popmenu-overlay").html('<div class="popmenu-overlay-empty">no result</div>'),$("#popmenu-overlay").show()}else $("#popmenu-overlay").hide(),$("#popmenu-overlay").html("");break;case"speakWord":if(s&&this.speakMarker.unmark(),a&&"START"===this.state.speak){const e=this.state.speakStartPos+a.charIndex;this.setState({speakPos:e}),this.speakMarker.markRanges([{start:e,length:a.length}],{className:"mark-word",element:"span",done:()=>{const e=document.querySelector("span.mark-word");if(!e)return;const{top:t,height:a}=e.getBoundingClientRect();t+a>window.innerHeight&&this.scrollTo(e)}})}break;case"speakVoice":$(`[click-state="speakVoice=${s}"]`).removeClass("selected"),$(`[click-state="speakVoice=${a}"]`).addClass("selected"),"START"===this.state.speak&&(this.setState({speak:"PAUSE"},o),this.setState({speak:"START"},o)),"click"===o&&this.config&&this.config.speakVoiceMap[this.getMainLang()]!==a&&("object"!=typeof this.config.speakVoiceMap&&(this.config.speakVoiceMap={}),this.setConfig({speakVoiceMap:{...this.config.speakVoiceMap,[this.getMainLang()]:a}}))}}handleStateShow(t,a,s){e("handle show state",t,a,s),$(`[show-state-${t}]`).hide(),$(`[show-state-${t}]`).removeClass("show-state"),a=a||"@",$(`[show-state-${t}*="${a}"]`).show(),$(`[show-state-${t}*="${a}"]`).addClass("show-state")}handleStateBind(t,a,s){e("handle bind state",t,a,s),$(`[bind="${t}"]`).text(a)}handleConfig(t,a,s,o){if(e("handleConfig",arguments),a!==s&&("object"!=typeof a||JSON.stringify(a)!==JSON.stringify(s))){switch(t){case"theme":$("#themes .btn-selected").removeClass("btn-selected"),$(`#themes .btn-theme-${a}`).addClass("btn-selected"),this.selectTheme(s);break;case"themeDay":$("#themes-day .btn-selected").removeClass("btn-selected"),$(`#themes-day .btn-theme-${a}`).addClass("btn-selected"),this.selectTheme(s);break;case"themeNight":$("#themes-night .btn-selected").removeClass("btn-selected"),$(`#themes-night .btn-theme-${a}`).addClass("btn-selected"),this.selectTheme(s);break;case"zoom":document.getElementById("container").style.zoom=a,$("#value-zoom").text((100*a).toFixed(0)+"%");break;case"width":$("#value-width").text(10*(10+parseInt(a)-2)+"%"),$("#root").removeClass("width-"+s),$("#root").addClass("width-"+a);break;case"themeAuto":a?($("#themes-day").show(),$("#themes-night").show(),$("#themes").hide(),$("#switch-theme").addClass("s-on"),$("#switch-theme").removeClass("s-off")):($("#themes-day").hide(),$("#themes-night").hide(),$("#themes").show(),$("#switch-theme").removeClass("s-on"),$("#switch-theme").addClass("s-off")),this.selectTheme(s);break;case"outline":a?($("#outline").show(),$("#switch-outline").addClass("s-on"),$("#switch-outline").removeClass("s-off")):($("#outline").hide(),$("#switch-outline").removeClass("s-on"),$("#switch-outline").addClass("s-off"));break;case"linkOpenNew":a?($("#switch-linkopennew").addClass("s-on"),$("#switch-linkopennew").removeClass("s-off")):($("#switch-linkopennew").removeClass("s-on"),$("#switch-linkopennew").addClass("s-off"));break;case"background":a?($("#switch-background").addClass("s-on"),$("#switch-background").removeClass("s-off"),$("html").removeClass("background-disabled")):($("#switch-background").removeClass("s-on"),$("#switch-background").addClass("s-off"),$("html").addClass("background-disabled"));break;case"syntax":a?($("#switch-syntax").addClass("s-on"),$("#switch-syntax").removeClass("s-off")):($("#switch-syntax").removeClass("s-on"),$("#switch-syntax").addClass("s-off"));break;case"translateLang":$("#poptranslate-lang").val(a);break;case"speakRate":$(`[click-config="speakRate=${s}"]`).removeClass("selected"),$(`[click-config="speakRate=${a}"]`).addClass("selected"),"START"===this.state.speak&&(this.setState({speak:"PAUSE"},o),this.setState({speak:"START"},o));break;case"voices":$("#menu-voices").append('<span class="item-voice" click-state="speakVoice=auto;showVoiceSelector=0">Auto</span>'),a&&a.length>0&&a.filter(e=>!e.remote&&e.lang.split("-").shift()===this.getMainLang()).forEach(e=>{$("#menu-voices").append(`<span class="item-voice" click-state="speakVoice=${e.voiceName};showVoiceSelector=0">${e.voiceName}</span>`)});break;case"speakVoiceMap":this.setState({speakVoice:a&&a[this.getMainLang()]?a[this.getMainLang()]:"auto"},o);break;case"readUpdates":a!==this.config.clearly.version?$("#btn-about").addClass("info"):$("#btn-about").removeClass("info");break;case"clearly":this.setState({version:a.version});break;default:t.startsWith("font_")&&($(".font-selected").removeClass("font-selected"),$(`.font-${a}`).addClass("font-selected"),$("#main,#outline").attr("class",""),$("#main,#outline").addClass("font-"+a))}"init"!==o&&(this.sendGA(["_trackEvent","APP_CONFIG","CONFIG_"+t.toUpperCase(),"CONFIG_"+String(a).toUpperCase()]),this.saveConfig())}}getMainLang(){return this.config&&this.config.lang&&this.config.lang.split("-").shift()||"en"}selectTheme(e){let t="default";if(this.config&&this.config.themeAuto){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;t=this.config[e?"themeNight":"themeDay"]}else t=this.config.theme;$("html").removeClass("theme-"+e),$("html").addClass("theme-"+t)}saveConfig(){if(this.config)return e("saveConfig",this.config),this.callBackground("saveConfig",{config:this.config})}sendGA(e){this.callBackground("ga",{data:e})}callParent(t){e("sendParent",t),parent.postMessage(t,"*")}callBackground(t,a){return e("callBackgroud",t,a),new Promise((e,s)=>{const o=String(Math.random());this.callbackWait(o,(t,a)=>{if(t)return s(t);e(a)}),parent.postMessage({...a||{},background:!0,type:t,callback:o},"*")})}callbackWait(t,a){e("callbackWait",t,a),this.callbacks[t]={fn:a,ts:Date.now()}}callbackReceive(t,a,s){e("callbackReceive",t,s,a);const{fn:o}=this.callbacks[t]||{};o&&o(s,a)}callbackStart(){e("callbackLoop"),this.callbacks||(this.callbacks={}),window.setInterval(e=>{const t=Date.now();Object.keys(this.callbacks).forEach(e=>{const{fn:a,ts:s}=this.callbacks[e];let o=null;t-s>1e4&&(delete this.callbacks[e],a(o=new Error(`call "${e}" timeout`),null))})},1e3)}stopAll(){this.state.speak&&this.callBackground("speakStop").then(()=>this.setState({speak:null}))}translate(e,t){return this.callBackground("translate",{lang:t,text:e})}scrollTo(e){const t=document.body,a=Math.max(t.scrollHeight,t.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),s=window.innerHeight||document.documentElement.clientHeight||t.clientHeight,o="number"==typeof e?e:e.offsetTop,n=Math.round(a-o<s?a-s:o);window.scroll(0,n)}handleClickOutline(e){e.preventDefault(),e.stopPropagation();let t=$(e.target).data("id");if(t){if("#"===t||!t)return window.scroll(0,0);let e=document.querySelector(t);e&&this.scrollTo(e)}else{const t=document.querySelector("#content").querySelector(`a[href="${e.target.getAttribute("href")}"]`);t&&($(t).addClass("outline-clicked"),setTimeout(e=>$(t).removeClass("outline-clicked"),1e3),this.scrollTo(t))}this.sendGA(["_trackEvent","CHROME_APP","CLICK_OUTLINE"])}bindEvents(){$("#outline").on("click","a",e=>this.handleClickOutline(e)),$("#btn-report").click(()=>this.action("report")),$("#themes .btn-theme-default").click(()=>this.action("theme","default")),$("#themes .btn-theme-yellow").click(()=>this.action("theme","yellow")),$("#themes .btn-theme-black").click(()=>this.action("theme","black")),$("#themes .btn-theme-gray").click(()=>this.action("theme","gray")),$("#themes-day .btn-theme-default").click(()=>this.action("themeDay","default")),$("#themes-day .btn-theme-yellow").click(()=>this.action("themeDay","yellow")),$("#themes-night .btn-theme-black").click(()=>this.action("themeNight","black")),$("#themes-night .btn-theme-gray").click(()=>this.action("themeNight","gray")),$("#btn-close").click(()=>this.action("close")),$("#btn-print").click(()=>this.action("print")),$("#btn-copy-article").click(()=>this.action("copyArticle")),$("#btn-copy-markdown").click(()=>this.action("copyMarkdown")),$("#btn-copy-html").click(()=>this.action("copyHTML")),$("#btn-export-pdf").click(()=>this.action("exportPDF")),$("#btn-export-doc").click(()=>this.action("exportDoc")),$("#btn-export-md").click(()=>this.action("exportMarkdown")),$("#btn-zoomin").click(()=>this.action("zoomIn")),$("#btn-zoomout").click(()=>this.action("zoomOut")),$("#btn-content-zoomin").click(()=>this.action("decreseWidth")),$("#btn-content-zoomout").click(()=>this.action("increseWidth")),$("#switch-outline").click(()=>this.action("toggleOutline")),$("#switch-linkopennew").click(()=>this.action("toggleLinkOpenNew")),$("#switch-background").click(()=>this.action("toggleBackground")),$("#switch-syntax").click(()=>this.action("toggleSyntax")),$("#switch-theme").click(()=>this.action("toggleAutotheme")),$("#menu-fullscreen").click(()=>this.action("toggleFullscreenMode")),$("#tool").on("click mousemove","[click-state],[mousemove-state]",e=>this.handleData("state",e)),$("#tool").on("click mousemove","[click-config],[mousemove-config]",e=>this.handleData("config",e)),$("#btn-thumb-up").click(()=>this.action("share","yes")),$("#btn-thumb-down").click(()=>this.action("share","no")),$("#content,#subject").click(e=>{setTimeout(t=>{this.getAndSaveSelection()&&(this.showPopmenu(e),e.stopPropagation())},100)}),$(".popmenu-item").click(e=>this.clickPopmenu($(e.target).data("type"))),$("#popmenu,#popshare,#poptranslate").click(e=>{this.keepSelection(),e.stopPropagation()}),$("#poptranslate-lang").change(e=>this.action("changeLanguage",$(e.target).val())),$("#poptranslate-btn-speak").click(()=>this.action("speakText",$("#poptranslate-word").text())),$("#font-select-style").on("click","span",e=>{this.action("font",$(e.target).data("font"))}),$("html").on("keyup",e=>{"Escape"===e.originalEvent.code&&(this.action("close"),this.sendGA(["_trackEvent","CHROME_APP","SHORTCUT_CLOSE"]))}),$("#content").on("mousemove",e=>this.showClearlyBtn(e)),$("#clearly-btn").click(e=>this.openClearlyBtn(e)),$("#content").on("click","a",e=>this.handleClick(e)),window.addEventListener("scroll",this.calcOutlinePos)}calcOutlinePos(){const e=document.querySelectorAll(".ros");let t=null;for(let a=0;a<e.length&&e[a].getBoundingClientRect().top<100;a++)t=e[a];if(t){const e=t.getAttribute("id"),a=e&&e.startsWith("ros-")?e.split("-").pop():0,s=document.querySelector(`#outline-ros-${a}`);if(s&&!s.classList.contains("outline-active")){const e=document.querySelectorAll(".outline-section");for(let t=0;t<e.length;t++)String(t)===String(a)?e[t].classList.add("outline-active"):e[t].classList.remove("outline-active")}}}handleData(e,t){const a=$(t.currentTarget).attr(`${t.type}-${e}`);if(!a)return;const s="state"===e?"setState":"setConfig";a.split(";").forEach(e=>{const[t,a]=e.split("=");if(a.includes("/")){const[e,o]=a.split("/");this[s]({[t]:this.state[t]===e?o:e},"click")}else this[s]({[t]:a},"click")})}handleParentMessage(e){if(e){if(e.callback)return this.callbackReceive(e.callback,e.result,e.error);switch(e.type){case"UPDATE":this.setState({isReady:!0}),this.show(e,!0);break;case"SPEAK":this.setState({speak:e.speak?e.speak.toUpperCase():null});break;case"SPEAK_WORD":this.setState({speakWord:e})}}}setIcon(e){this.callBackground("updateIcon",{status:e})}getDefaultState(){return{speak:null,speakStartPos:0,speakPos:0,fullscreen:!1,isReady:!1,isTranslate:!1,translateResult:null,isSharing:!1,fonts:[{name:"Lora",lang:["en"],system:["win","mac"]},{name:"NotoSerif",lang:["en"],system:["win","mac"]},{name:"Crimson Text",lang:["en"],system:["win","mac"]},{name:"Georgia",lang:["en"],system:["win","mac"]},{name:"Roboto",lang:["en"],system:["win","mac"]},{name:"Kaiti",lang:["zh"],system:["win","mac"]},{name:"Songti",lang:["zh"],system:["win","mac"]},{name:"System",lang:["zh","en"],system:["win","mac"]}]}}setState(e,t){this.state||(this.state={}),Object.keys(e).forEach(a=>{const s=this.state[a];this.state[a]=e[a],this.handleState(a,e[a],s,t)})}setConfig(e,t){this.config||(this.config={}),Object.keys(e).forEach(a=>{const s=this.config[a];this.config[a]=e[a],this.handleConfig(a,e[a],s,t)})}getSelectionCharOffsets(){let e,t,a,s=0,o=0;const n=document.querySelector("#content");return void 0!==window.getSelection?((a=(t=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(n),a.setEnd(t.startContainer,t.startOffset),o=(s=a.toString().length)+t.toString().length):void 0!==document.selection&&"Control"!==(e=document.selection).type&&(t=e.createRange(),(a=document.body.createTextRange()).moveToElementText(n),a.setEndPoint("EndToStart",t),o=(s=a.text.length)+t.text.length),{start:s,end:o,length:o-s}}async bootstrap(){let t;try{t=JSON.parse($("#config").text())}catch(e){t=await this.callBackground("getConfig"),console.error(e)}this.setConfig(t,"init"),this.setState(this.getDefaultState()),this.boot=!0,window.addEventListener("message",t=>{e("Frame received message",t.data),this.handleParentMessage(t.data)},!1)}}).bootstrap();